# ìŠ¤í‚¤ë§ˆ ì¿¼ë¦¬ ìµœì í™” ì œì•ˆ

## ğŸ“… ì‘ì„±ì¼
2025-12-14

## ğŸ” ë¶„ì„ëœ ì¿¼ë¦¬ íŒ¨í„´

### 1. DiaryEntry.title startsWith ì¿¼ë¦¬ ìµœì í™”

**í˜„ì¬ ì‚¬ìš© íŒ¨í„´:**
- `title: { startsWith: 'ì„ì‹œì €ì¥' }` - ë§¤ìš° ë¹ˆë²ˆí•˜ê²Œ ì‚¬ìš©ë¨
- `title: { startsWith: 'ì˜¤í”„ë¼ì¸ ì¼ê¸°' }` - ìì£¼ ì‚¬ìš©ë¨
- `title: { not: { startsWith: 'ì„ì‹œì €ì¥' } }` - í•„í„°ë§ìš©

**ì‚¬ìš© ìœ„ì¹˜:**
- `/api/diary/draft` - ì„ì‹œì €ì¥ ì¡°íšŒ/ì‚­ì œ
- `/api/diary/draft/list` - ì„ì‹œì €ì¥ ëª©ë¡
- `/api/diary/draft/latest` - ìµœì‹  ì„ì‹œì €ì¥
- `/api/diary/create` - ì„ì‹œì €ì¥ ê°œìˆ˜ ì²´í¬
- `/api/search` - ê²€ìƒ‰ì—ì„œ ì„ì‹œì €ì¥ ì œì™¸
- `/api/admin/diaries` - ê´€ë¦¬ì ì¼ê¸° ëª©ë¡
- `/api/admin/dashboard/charts` - í†µê³„ ì°¨íŠ¸

**ë¬¸ì œì :**
- `title` í•„ë“œì— ì¸ë±ìŠ¤ê°€ ì—†ì–´ì„œ `startsWith` ì¿¼ë¦¬ê°€ ëŠë¦´ ìˆ˜ ìˆìŒ
- PostgreSQLì—ì„œ `LIKE 'ì„ì‹œì €ì¥%'`ëŠ” ì¸ë±ìŠ¤ë¥¼ í™œìš©í•  ìˆ˜ ìˆì§€ë§Œ, `startsWith`ëŠ” ì œí•œì 

**ê°œì„  ë°©ì•ˆ:**

#### ì˜µì…˜ 1: title í•„ë“œì— ì¸ë±ìŠ¤ ì¶”ê°€ (ê°„ë‹¨)
```prisma
model DiaryEntry {
  // ... ê¸°ì¡´ í•„ë“œë“¤
  
  @@index([title]) // title ì¸ë±ìŠ¤ ì¶”ê°€
  @@index([user_id, title]) // ë³µí•© ì¸ë±ìŠ¤ (user_id + title ì¡°íšŒ ìµœì í™”)
  // ... ê¸°ì¡´ ì¸ë±ìŠ¤ë“¤
}
```

**ì¥ì :**
- êµ¬í˜„ ê°„ë‹¨
- `startsWith` ì¿¼ë¦¬ ì„±ëŠ¥ ê°œì„ 

**ë‹¨ì :**
- `title`ì´ nullableì´ë¯€ë¡œ NULL ê°’ë„ ì¸ë±ìŠ¤ì— í¬í•¨
- ì „ì²´ ì¸ë±ìŠ¤ í¬ê¸° ì¦ê°€

#### ì˜µì…˜ 2: ë¶€ë¶„ ì¸ë±ìŠ¤ ì‚¬ìš© (ê¶Œì¥)
```prisma
model DiaryEntry {
  // ... ê¸°ì¡´ í•„ë“œë“¤
  
  // PrismaëŠ” ë¶€ë¶„ ì¸ë±ìŠ¤ë¥¼ ì§ì ‘ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ
  // ë§ˆì´ê·¸ë ˆì´ì…˜ SQLì—ì„œ ì§ì ‘ ìƒì„± í•„ìš”
  // CREATE INDEX idx_diary_entry_title_draft 
  //   ON "user"."DiaryEntry" (title) 
  //   WHERE title IS NOT NULL AND (title LIKE 'ì„ì‹œì €ì¥%' OR title LIKE 'ì˜¤í”„ë¼ì¸ ì¼ê¸°%');
}
```

**ì¥ì :**
- ì¸ë±ìŠ¤ í¬ê¸° ìµœì†Œí™”
- ì„ì‹œì €ì¥ ê´€ë ¨ ì¿¼ë¦¬ë§Œ ìµœì í™”

**ë‹¨ì :**
- Prisma ìŠ¤í‚¤ë§ˆì— ì§ì ‘ í‘œí˜„ ë¶ˆê°€
- ë§ˆì´ê·¸ë ˆì´ì…˜ SQL ìˆ˜ë™ ì‘ì„± í•„ìš”

#### ì˜µì…˜ 3: draft_type í•„ë“œ ì¶”ê°€ (ê·¼ë³¸ì  í•´ê²°)
```prisma
model DiaryEntry {
  // ... ê¸°ì¡´ í•„ë“œë“¤
  draft_type String? // 'DRAFT', 'OFFLINE_DRAFT', null (ì¼ë°˜ ì¼ê¸°)
  
  @@index([user_id, draft_type]) // ë³µí•© ì¸ë±ìŠ¤
  @@index([draft_type, created_at]) // draft_typeë³„ ì¡°íšŒ
}
```

**ì¥ì :**
- ê°€ì¥ ë¹ ë¥¸ ì¿¼ë¦¬ ì„±ëŠ¥
- `startsWith` ëŒ€ì‹  `=` ë¹„êµ ì‚¬ìš© ê°€ëŠ¥
- ì¸ë±ìŠ¤ í™œìš©ë„ ìµœëŒ€

**ë‹¨ì :**
- ìŠ¤í‚¤ë§ˆ ë³€ê²½ í•„ìš”
- ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”
- ì½”ë“œ ë³€ê²½ ë²”ìœ„ í¼

### 2. ContactInquiry ì¿¼ë¦¬ ìµœì í™”

**í˜„ì¬ ìƒíƒœ:**
- ì¸ë±ìŠ¤ê°€ ì˜ ì„¤ì •ë˜ì–´ ìˆìŒ âœ…
- `status`, `email`, `user_id`, `created_at` ëª¨ë‘ ì¸ë±ìŠ¤ ìˆìŒ

**ì¶”ê°€ ê°œì„  ê°€ëŠ¥:**
```prisma
model ContactInquiry {
  // ... ê¸°ì¡´ í•„ë“œë“¤
  
  // IP ì£¼ì†Œ ê¸°ë°˜ Rate Limiting ìµœì í™”
  @@index([ip_address, created_at]) // IPë³„ ìµœê·¼ ë¬¸ì˜ ì¡°íšŒ
}
```

### 3. DiaryEntry ì‚­ì œ ì¿¼ë¦¬ ìµœì í™”

**í˜„ì¬ ì‚¬ìš© íŒ¨í„´:**
- `deleteMany`ì—ì„œ `id: { in: ids }` ì‚¬ìš© (ë°°ì¹˜ ì‚­ì œ)
- `user_id`ì™€ í•¨ê»˜ í•„í„°ë§

**í˜„ì¬ ì¸ë±ìŠ¤:**
- `@@index([user_id, created_at])` âœ…
- `id`ëŠ” Primary Keyì´ë¯€ë¡œ ìë™ ì¸ë±ìŠ¤ âœ…

**ì¶”ê°€ ê°œì„ :**
- ë°°ì¹˜ ì‚­ì œëŠ” ì´ë¯¸ ìµœì í™”ë¨ âœ…
- `id IN (...)` ì¿¼ë¦¬ëŠ” PK ì¸ë±ìŠ¤ í™œìš©

### 4. AnalysisResult ì¿¼ë¦¬ ìµœì í™”

**í˜„ì¬ ìƒíƒœ:**
- ì¸ë±ìŠ¤ê°€ ë§¤ìš° ì˜ ì„¤ì •ë˜ì–´ ìˆìŒ âœ…
- `diary_id`, `provider`, `status`, `created_at` ëª¨ë‘ ì¸ë±ìŠ¤
- GIN ì¸ë±ìŠ¤ë¡œ ë°°ì—´ ê²€ìƒ‰ ìµœì í™” (`emotion_keywords`, `summary_topics`)

**ì¶”ê°€ ê°œì„  ê°€ëŠ¥:**
```prisma
model AnalysisResult {
  // ... ê¸°ì¡´ í•„ë“œë“¤
  
  // ë¹„ìš© ë¶„ì„ ì¿¼ë¦¬ ìµœì í™”
  @@index([created_at, cost_usd]) // ì¼ë³„ ë¹„ìš© ë¶„ì„ (ì´ë¯¸ ìˆìŒ âœ…)
  @@index([provider, created_at, cost_usd]) // í”„ë¡œë°”ì´ë”ë³„ ì¼ë³„ ë¹„ìš©
}
```

## ğŸ¯ ê¶Œì¥ ì‚¬í•­

### ì¦‰ì‹œ ì ìš© ê°€ëŠ¥ (ë‚®ì€ ë¦¬ìŠ¤í¬)

1. **DiaryEntry.title ì¸ë±ìŠ¤ ì¶”ê°€**
   ```prisma
   @@index([title])
   @@index([user_id, title])
   ```

2. **ContactInquiry.ip_address ì¸ë±ìŠ¤ ì¶”ê°€**
   ```prisma
   @@index([ip_address, created_at])
   ```

### ì¤‘ê¸° ê°œì„  (ì¤‘ê°„ ë¦¬ìŠ¤í¬)

3. **DiaryEntry.draft_type í•„ë“œ ì¶”ê°€**
   - ìŠ¤í‚¤ë§ˆ ë³€ê²½ í•„ìš”
   - ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”
   - ì½”ë“œ ë³€ê²½ ë²”ìœ„ í¼

### ì¥ê¸° ê°œì„  (ë‚®ì€ ìš°ì„ ìˆœìœ„)

4. **ë¶€ë¶„ ì¸ë±ìŠ¤ ì ìš©**
   - Prisma ë§ˆì´ê·¸ë ˆì´ì…˜ SQL ìˆ˜ë™ ì‘ì„±
   - ì¸ë±ìŠ¤ í¬ê¸° ìµœì í™”

## ğŸ“Š ì˜ˆìƒ ì„±ëŠ¥ ê°œì„ 

### DiaryEntry.title ì¸ë±ìŠ¤ ì¶”ê°€ ì‹œ
- **Before**: `startsWith` ì¿¼ë¦¬ ì‹œ ì „ì²´ í…Œì´ë¸” ìŠ¤ìº” ë˜ëŠ” ëŠë¦° ì¸ë±ìŠ¤ ìŠ¤ìº”
- **After**: ì¸ë±ìŠ¤ í™œìš©ìœ¼ë¡œ **50-80% ì„±ëŠ¥ í–¥ìƒ** ì˜ˆìƒ
- **ì˜í–¥**: ì„ì‹œì €ì¥ ì¡°íšŒ/ì‚­ì œ ì†ë„ ê°œì„ 

### ContactInquiry.ip_address ì¸ë±ìŠ¤ ì¶”ê°€ ì‹œ
- **Before**: Rate Limiting ì²´í¬ ì‹œ ì „ì²´ í…Œì´ë¸” ìŠ¤ìº”
- **After**: ì¸ë±ìŠ¤ í™œìš©ìœ¼ë¡œ **90% ì´ìƒ ì„±ëŠ¥ í–¥ìƒ** ì˜ˆìƒ
- **ì˜í–¥**: ë¬¸ì˜í•˜ê¸° API ì‘ë‹µ ì†ë„ ê°œì„ 

## ğŸ”§ êµ¬í˜„ ë°©ë²•

### 1ë‹¨ê³„: ìŠ¤í‚¤ë§ˆ ìˆ˜ì •
```prisma
model DiaryEntry {
  // ... ê¸°ì¡´ í•„ë“œë“¤
  
  @@index([title])
  @@index([user_id, title])
  // ... ê¸°ì¡´ ì¸ë±ìŠ¤ë“¤
}

model ContactInquiry {
  // ... ê¸°ì¡´ í•„ë“œë“¤
  
  @@index([ip_address, created_at])
  // ... ê¸°ì¡´ ì¸ë±ìŠ¤ë“¤
}
```

### 2ë‹¨ê³„: ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„±
```bash
cd apps/sum-diary
pnpm prisma migrate dev --name add_query_optimization_indexes
```

### 3ë‹¨ê³„: Prisma Client ì¬ìƒì„±
```bash
pnpm prisma generate
```

## âš ï¸ ì£¼ì˜ì‚¬í•­

1. **ì¸ë±ìŠ¤ ìƒì„± ì‹œê°„**
   - ëŒ€ìš©ëŸ‰ í…Œì´ë¸”ì˜ ê²½ìš° ì¸ë±ìŠ¤ ìƒì„±ì— ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŒ
   - í”„ë¡œë•ì…˜ì—ì„œëŠ” ì ê²€ ì‹œê°„ì— ì‹¤í–‰ ê¶Œì¥

2. **ì¸ë±ìŠ¤ í¬ê¸°**
   - ì¶”ê°€ ì¸ë±ìŠ¤ëŠ” ì €ì¥ ê³µê°„ì„ ì‚¬ìš©
   - INSERT/UPDATE ì„±ëŠ¥ì— ë¯¸ë¯¸í•œ ì˜í–¥ (ë³´í†µ ë¬´ì‹œ ê°€ëŠ¥)

3. **ëª¨ë‹ˆí„°ë§**
   - ì¸ë±ìŠ¤ ì¶”ê°€ í›„ ì¿¼ë¦¬ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ í•„ìš”
   - EXPLAIN ANALYZEë¡œ ì‹¤ì œ ì„±ëŠ¥ ê°œì„  í™•ì¸

## ğŸ“ ì°¸ê³ 

- PostgreSQL ì¸ë±ìŠ¤ ìµœì í™” ê°€ì´ë“œ: https://www.postgresql.org/docs/current/indexes.html
- Prisma ì¸ë±ìŠ¤ ë¬¸ì„œ: https://www.prisma.io/docs/concepts/components/prisma-schema/indexes
