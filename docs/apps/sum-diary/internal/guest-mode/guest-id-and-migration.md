# ê²ŒìŠ¤íŠ¸ ID ë¶€ì—¬ ë°©ì‹ ë° ì¼ê¸° ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ

## ê²ŒìŠ¤íŠ¸ ID ë¶€ì—¬ ë°©ì‹

### 1. ì„œë²„ ì‚¬ì´ë“œ ê²ŒìŠ¤íŠ¸ ID (ê¸°ë³¸)

**ìƒì„± ë°©ì‹**: IP ì£¼ì†Œ ê¸°ë°˜
- **í˜•ì‹**: `SHA-256("guest_{IP}")` â†’ UUID í˜•ì‹ ë³€í™˜
- **íŠ¹ì§•**: 
  - ê°™ì€ IPì—ì„œ ì ‘ì†í•˜ë©´ í•­ìƒ ê°™ì€ ê²ŒìŠ¤íŠ¸ ID ë¶€ì—¬
  - ë„¤íŠ¸ì›Œí¬/ìœ„ì¹˜ ë³€ê²½ ì‹œ ë‹¤ë¥¸ ê²ŒìŠ¤íŠ¸ ID ìƒì„±ë¨
  - í”„ë¡ì‹œ/ë¡œë“œë°¸ëŸ°ì„œ í™˜ê²½ì—ì„œë„ ì •í™•í•œ IP ì¶”ì¶œ

**IP ì¶”ì¶œ ìš°ì„ ìˆœìœ„**:
1. `x-forwarded-for` í—¤ë” (í”„ë¡ì‹œ ë’¤)
2. `x-real-ip` í—¤ë”
3. ê°œë°œ í™˜ê²½: `127.0.0.1`
4. ì•Œ ìˆ˜ ì—†ìŒ: `'unknown'`

### 2. í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ê²ŒìŠ¤íŠ¸ ID (ê°œì„ )

**ì €ì¥ ìœ„ì¹˜**: `localStorage` (`hua_guest_id` í‚¤)
- **í˜•ì‹**: UUID v4 (í‘œì¤€ í˜•ì‹)
- **íŠ¹ì§•**:
  - ê°™ì€ ê¸°ê¸°/ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì¼ê´€ëœ ID ìœ ì§€
  - IPê°€ ë³€ê²½ë˜ì–´ë„ ê°™ì€ ê¸°ê¸°ì—ì„œëŠ” ë™ì¼ ID ì‚¬ìš©
  - ë¸Œë¼ìš°ì €ë¥¼ ë‹«ì•„ë„ ìœ ì§€ë¨ (localStorage)

**ìƒì„± ì‹œì **:
- ê²ŒìŠ¤íŠ¸ë¡œ ì²« ì¼ê¸° ì‘ì„± ì‹œ ìë™ ìƒì„±
- ë˜ëŠ” `getOrCreateClientGuestId()` í˜¸ì¶œ ì‹œ

**ì‚¬ìš© ëª©ì **:
- ë‹¤ë¥¸ IPì—ì„œ ì ‘ì†í•´ë„ ê°™ì€ ê¸°ê¸°/ë¸Œë¼ìš°ì €ì—ì„œ ì‘ì„±í•œ ê²ŒìŠ¤íŠ¸ ì¼ê¸° ì¶”ì  ê°€ëŠ¥
- íšŒì›ê°€ì…/ë¡œê·¸ì¸ ì‹œ ì—¬ëŸ¬ ê²ŒìŠ¤íŠ¸ IDë¥¼ í•˜ë‚˜ì˜ ê³„ì •ìœ¼ë¡œ í†µí•©

## ê²ŒìŠ¤íŠ¸ ì¼ê¸° ë§ˆì´ê·¸ë ˆì´ì…˜ ë¡œì§

### ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ëµ

íšŒì›ê°€ì…/ë¡œê·¸ì¸ ì‹œ ë‹¤ìŒê³¼ ê°™ì€ ìˆœì„œë¡œ ê²ŒìŠ¤íŠ¸ ì¼ê¸°ë¥¼ ì°¾ì•„ í†µí•©í•©ë‹ˆë‹¤:

1. **í˜„ì¬ IP ê¸°ë°˜ ê²ŒìŠ¤íŠ¸ ID**
   - í˜„ì¬ ì ‘ì† ìœ„ì¹˜ì—ì„œ ì‘ì„±í•œ ê²ŒìŠ¤íŠ¸ ì¼ê¸°

2. **í´ë¼ì´ì–¸íŠ¸ LocalStorage ê²ŒìŠ¤íŠ¸ ID**
   - ê°™ì€ ê¸°ê¸°/ë¸Œë¼ìš°ì €ì—ì„œ ì‘ì„±í•œ ê²ŒìŠ¤íŠ¸ ì¼ê¸° (IP ë³€ê²½ ë¬´ê´€)

3. **ìµœê·¼ ì ‘ì† íŒ¨í„´ ê¸°ë°˜**
   - ìµœê·¼ 30ì¼ ì´ë‚´ ë™ì¼ IP ëŒ€ì—­ì—ì„œ ì‘ì„±í•œ ê²ŒìŠ¤íŠ¸ ì¼ê¸°
   - (ë™ì  IPì´ì§€ë§Œ ë¹„ìŠ·í•œ ìœ„ì¹˜ì—ì„œ ì ‘ì†í•œ ê²½ìš°)

### ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ ì‹œì 

#### 1. íšŒì›ê°€ì… ì‹œ
```typescript
// ìë™ ì‹¤í–‰ (ë¹„ë™ê¸°)
POST /api/auth/register
{
  email, password, nickname,
  clientGuestId: "..." // í´ë¼ì´ì–¸íŠ¸ LocalStorage ê²ŒìŠ¤íŠ¸ ID
}
```

#### 2. ë¡œê·¸ì¸ í›„ (ì¼ë°˜ ë¡œê·¸ì¸ + ì†Œì…œ ë¡œê·¸ì¸)
```typescript
// useGuestDiaryMigration í›…ì—ì„œ ìë™ ì‹¤í–‰
// í™ˆ í˜ì´ì§€("/") ë˜ëŠ” Dashboard ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‹¤í–‰
POST /api/user/migrate-guest-diaries
{
  clientGuestId: "..." // í´ë¼ì´ì–¸íŠ¸ LocalStorage ê²ŒìŠ¤íŠ¸ ID
}
```
- **ì¼ë°˜ ë¡œê·¸ì¸**: ë¡œê·¸ì¸ í›„ í™ˆ í˜ì´ì§€ë¡œ ì´ë™ â†’ ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜
- **ì†Œì…œ ë¡œê·¸ì¸**: callbackUrl "/"ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ â†’ ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜
- **ì¤‘ë³µ ë°©ì§€**: `sessionStorage.getItem('guest_migration_checked')`ë¡œ ì„¸ì…˜ë‹¹ í•œ ë²ˆë§Œ ì‹¤í–‰

#### 3. ìˆ˜ë™ í˜¸ì¶œ
```typescript
// í•„ìš” ì‹œ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰ ê°€ëŠ¥
GET /api/user/migrate-guest-diaries // í™•ì¸
POST /api/user/migrate-guest-diaries // ì‹¤í–‰
```

### ë§ˆì´ê·¸ë ˆì´ì…˜ ê²°ê³¼

**ì„±ê³µ ì‹œ**:
```json
{
  "success": true,
  "migratedCount": 5,
  "migratedByGuestId": [
    {
      "guestId": "abc12345-...",
      "count": 3,
      "source": "current_ip"
    },
    {
      "guestId": "def67890-...",
      "count": 2,
      "source": "client_storage"
    }
  ],
  "message": "ê¸°ì¡´ì— ì‘ì„±í•˜ì‹  ì¼ê¸° 5ê°œë¥¼ ê³„ì •ì— ì—°ê²°í–ˆìŠµë‹ˆë‹¤. (í˜„ì¬ ì ‘ì† ìœ„ì¹˜: 3ê°œ, ê°™ì€ ê¸°ê¸°/ë¸Œë¼ìš°ì €: 2ê°œ)"
}
```

**ì‹¤íŒ¨ ë˜ëŠ” ì¼ê¸° ì—†ìŒ ì‹œ**:
```json
{
  "success": true,
  "migratedCount": 0,
  "notice": "ë‹¤ë¥¸ ê¸°ê¸°ë‚˜ ë„¤íŠ¸ì›Œí¬ì—ì„œ ì‘ì„±í•œ ì¼ê¸°ëŠ” ì°¾ì§€ ëª»í–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì¼ê¸°ë¥¼ ê°€ì ¸ì˜¤ë ¤ë©´ ê³ ê°ì§€ì›ì— ë¬¸ì˜í•´ì£¼ì„¸ìš”."
}
```

## âš ï¸ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨ ê°€ëŠ¥í•œ ê²½ìš°

### 1. ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ì‘ì„±í•œ ì¼ê¸°
- **ì›ì¸**: ê¸°ê¸°ë³„ë¡œ ë‹¤ë¥¸ LocalStorage ì‚¬ìš©
- **í•´ê²°**: ìˆ˜ë™ ë§ˆì´ê·¸ë ˆì´ì…˜ ë˜ëŠ” ê³ ê°ì§€ì› ë¬¸ì˜

### 2. ì˜¤ë˜ëœ ê²ŒìŠ¤íŠ¸ ì¼ê¸° (30ì¼ ì´ˆê³¼)
- **ì›ì¸**: ìµœê·¼ ì ‘ì† íŒ¨í„´ ê¸°ë°˜ ê²€ìƒ‰ì€ 30ì¼ ì´ë‚´ë§Œ ê²€ìƒ‰
- **í•´ê²°**: í˜„ì¬ IP ê¸°ë°˜ ê²ŒìŠ¤íŠ¸ IDë¡œëŠ” ì°¾ì„ ìˆ˜ ì—†ìŒ

### 3. VPN ë˜ëŠ” ì™„ì „íˆ ë‹¤ë¥¸ ë„¤íŠ¸ì›Œí¬
- **ì›ì¸**: IPê°€ ì™„ì „íˆ ë‹¬ë¼ì„œ íŒ¨í„´ ë§¤ì¹­ ë¶ˆê°€
- **í•´ê²°**: í´ë¼ì´ì–¸íŠ¸ ê²ŒìŠ¤íŠ¸ IDê°€ ì €ì¥ë˜ì–´ ìˆìœ¼ë©´ ì°¾ì„ ìˆ˜ ìˆìŒ

### 4. ë¸Œë¼ìš°ì € ë°ì´í„° ì‚­ì œ
- **ì›ì¸**: LocalStorage ì‚­ì œë¡œ í´ë¼ì´ì–¸íŠ¸ ê²ŒìŠ¤íŠ¸ ID ì†ì‹¤
- **í•´ê²°**: í˜„ì¬ IP ê¸°ë°˜ìœ¼ë¡œë§Œ ê²€ìƒ‰ (ì œí•œì )

## ğŸ“ ì‚¬ìš©ì ì•ˆë‚´ ë©”ì‹œì§€

### íšŒì›ê°€ì… í˜ì´ì§€ ì•ˆë‚´ (UI)
íšŒì›ê°€ì… í˜ì´ì§€ ìƒë‹¨ì— ë°°ë„ˆ í‘œì‹œ:
```
ğŸ’¡ ê²ŒìŠ¤íŠ¸ë¡œ ì‘ì„±í•œ ì¼ê¸°ë„ ìë™ìœ¼ë¡œ ì—°ê²°ë©ë‹ˆë‹¤!
ê°™ì€ ê¸°ê¸°/ë¸Œë¼ìš°ì €ì—ì„œ ì‘ì„±í•œ ì¼ê¸°ëŠ” ëŒ€ë¶€ë¶„ ìë™ìœ¼ë¡œ ì°¾ì•„ë“œë ¤ìš”.
```

### ë§ˆì´ê·¸ë ˆì´ì…˜ ë™ì‘ ë°©ì‹ ì•ˆë‚´
**ì„±ê³µ ì‹œ**:
- "ì¼ê¸° ì—°ê²° ì™„ë£Œ" í† ìŠ¤íŠ¸
- "ê¸°ì¡´ì— ì‘ì„±í•˜ì‹  ì¼ê¸° Nê°œë¥¼ ê³„ì •ì— ì—°ê²°í–ˆìŠµë‹ˆë‹¤. (í˜„ì¬ ì ‘ì† ìœ„ì¹˜: Xê°œ, ê°™ì€ ê¸°ê¸°/ë¸Œë¼ìš°ì €: Yê°œ)"

**ì¼ê¸° ì—†ìŒ/ì‹¤íŒ¨ ì‹œ**:
- "ì¼ê¸° ì—°ê²° ì•ˆë‚´" í† ìŠ¤íŠ¸
- "ë‹¤ë¥¸ ê¸°ê¸°ë‚˜ ë„¤íŠ¸ì›Œí¬ì—ì„œ ì‘ì„±í•œ ì¼ê¸°ëŠ” ì°¾ì§€ ëª»í–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì¼ê¸°ë¥¼ ê°€ì ¸ì˜¤ë ¤ë©´ ê³ ê°ì§€ì›ì— ë¬¸ì˜í•´ì£¼ì„¸ìš”."

### ë¡œê·¸ì¸ í›„ ë§ˆì´ê·¸ë ˆì´ì…˜ ê²°ê³¼ ì•ˆë‚´
**ì„±ê³µ ì‹œ**:
> "ì¼ê¸° ì—°ê²° ì™„ë£Œ
> ê¸°ì¡´ì— ì‘ì„±í•˜ì‹  ì¼ê¸° Nê°œë¥¼ ê³„ì •ì— ì—°ê²°í–ˆìŠµë‹ˆë‹¤.
> (í˜„ì¬ ì ‘ì† ìœ„ì¹˜: Xê°œ, ê°™ì€ ê¸°ê¸°/ë¸Œë¼ìš°ì €: Yê°œ)"

**ì¼ê¸° ì—†ìŒ ì‹œ**:
> "ì¼ê¸° ì—°ê²° ì•ˆë‚´
> ë‹¤ë¥¸ ê¸°ê¸°ë‚˜ ë„¤íŠ¸ì›Œí¬ì—ì„œ ì‘ì„±í•œ ì¼ê¸°ëŠ” ì°¾ì§€ ëª»í–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
> ìˆ˜ë™ìœ¼ë¡œ ì¼ê¸°ë¥¼ ê°€ì ¸ì˜¤ë ¤ë©´ ê³ ê°ì§€ì›ì— ë¬¸ì˜í•´ì£¼ì„¸ìš”."

## ğŸ”§ ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­

### ê²ŒìŠ¤íŠ¸ ID ìƒì„± ì½”ë“œ

**ì„œë²„ ì‚¬ì´ë“œ** (`guest-migration.ts`):
```typescript
export function generateGuestId(ip: string): string {
  const guestId = crypto.createHash('sha256')
    .update(`guest_${ip}`)
    .digest('hex')
    .substring(0, 32);
  // UUID í˜•ì‹: 8-4-4-4-12
  return `${guestId.substring(0, 8)}-${guestId.substring(8, 12)}-...`;
}
```

**í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ** (`client-guest-id.ts`):
```typescript
export function getOrCreateClientGuestId(): string {
  const existing = localStorage.getItem('hua_guest_id');
  if (existing && isValidUUID(existing)) return existing;
  
  const newId = generateUUID(); // UUID v4
  localStorage.setItem('hua_guest_id', newId);
  return newId;
}
```

### ë§ˆì´ê·¸ë ˆì´ì…˜ íŠ¸ëœì­ì…˜
```typescript
// 1. ê²ŒìŠ¤íŠ¸ ì¼ê¸° ì°¾ê¸°
const guestDiaries = await prisma.diaryEntry.findMany({
  where: { user_id: guestId, is_deleted: false }
});

// 2. íŠ¸ëœì­ì…˜ìœ¼ë¡œ user_id ì—…ë°ì´íŠ¸
await prisma.$transaction(async (tx) => {
  await tx.diaryEntry.updateMany({
    where: { user_id: guestId },
    data: { user_id: userId, updated_at: new Date() }
  });
  // ë¶„ì„ ê²°ê³¼ëŠ” diary_idë¡œ ì—°ê²°ë˜ì–´ ìë™ìœ¼ë¡œ ë”°ë¼ê°
});
```

