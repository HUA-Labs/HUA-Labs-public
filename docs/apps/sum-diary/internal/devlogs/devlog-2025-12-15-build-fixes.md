# ê°œë°œë¡œê·¸ - 2025ë…„ 12ì›” 15ì¼

## ğŸ“… ë‚ ì§œ
2025-12-15

## ğŸ“Š ì‘ì—… ìš”ì•½

ì˜¤ëŠ˜ì€ **Prisma 7.1.0 ì—…ë°ì´íŠ¸ ë° ë¹Œë“œ ì˜¤ë¥˜ í•´ê²°**, **ì¼ê¸° ë¶„ì„ UI í•˜ì´ë¼í‚¤ ë³€ê²½**, **ë¶„ì„ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€**, **ì„±ëŠ¥ ìµœì í™”**, **TypeScript ì˜¤ë¥˜ ìˆ˜ì •**, **ëª¨ë¸-í”„ë¡œë°”ì´ë” ìë™ ì„¤ì • ê¸°ëŠ¥**, **ì„ì‹œì €ì¥ ë‚ ì§œ ë³µêµ¬**, **Gemini API ì˜¤ë¥˜ ìˆ˜ì •**, **íŠ¸ëœì­ì…˜ íƒ€ì„ì•„ì›ƒ í•´ê²°** ì‘ì—…ì„ ì§„í–‰í–ˆìŠµë‹ˆë‹¤:

1. âœ… Prisma 7.1.0 ë§ˆì´ê·¸ë ˆì´ì…˜ (ìŠ¤í‚¤ë§ˆ íŒŒì¼ ì—…ë°ì´íŠ¸)
2. âœ… prisma.config.ts íŒŒì¼ ìƒì„±
3. âœ… PrismaClient adapter ì„¤ì • (@prisma/adapter-pg)
4. âœ… TypeScript ê²½ë¡œ ë§¤í•‘ ì„¤ì • ê°œì„ 
5. âœ… useToast íƒ€ì… ë¬¸ì œ í•´ê²°
6. âœ… i18n-test ë¹Œë“œ ì„¤ì • ìˆ˜ì • (Turbopack â†’ webpack)
7. âœ… turbo.json ë¹Œë“œ ì¶œë ¥ ì„¤ì • ì¶”ê°€
8. âœ… @hua-labs/ui ì„œë¸ŒíŒ¨í‚¤ì§€ ê²½ë¡œ ë§¤í•‘ ì¶”ê°€
9. âœ… PrismaClient adapter ë¹Œë“œ ì‹œ ì´ˆê¸°í™” ë¬¸ì œ í•´ê²° (ëª¨ë“  íŒŒì¼ì—ì„œ ì‹±ê¸€í†¤ ì‚¬ìš©)
10. âœ… next.config.ts deprecated ì„¤ì • ìˆ˜ì • (serverExternalPackages)
11. âœ… Vercel ì„œë²„ë¦¬ìŠ¤ í™˜ê²½ ëˆ„ìˆ˜ ë°©ì§€ (ë©”ëª¨ë¦¬ ìºì‹œ TTL, ì—°ê²° í’€ ìµœì í™”)
12. âœ… ì¼ê¸° ë¶„ì„ UI í•˜ì´ë¼í‚¤ ë³€ê²½ (ì œëª© â†’ ì§ˆë¬¸ â†’ ê°ì‘ë¶„ì„ â†’ ê¸°ë¡ ë” ë³´ê¸° â†’ ë‚˜ì˜ ê¸°ë¡)
13. âœ… ë¶„ì„ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ (PROCESSING ìƒíƒœ ì²´í¬)
14. âœ… ì¤‘ë³µ DB ì¡°íšŒ ìµœì í™” (3íšŒ â†’ 1íšŒ)
15. âœ… OpenAI/Gemini ìŠ¤íŠ¸ë¦¬ë° ë¡œì§ ì¤‘ë³µ ì œê±° (ê³µí†µ í•¨ìˆ˜ ì¶”ì¶œ)
16. âœ… í”„ë¡ íŠ¸ì—”ë“œ-ë°±ì—”ë“œ ì¤‘ë³µ í™•ì¸ ìµœì í™”
17. âœ… ë¶ˆí•„ìš”í•œ ë¡œê·¸ ìµœì í™” (í”„ë¡œë•ì…˜ DEBUG ë¡œê·¸ ì¡°ê±´ë¶€ ì²˜ë¦¬)
18. âœ… TypeScript ì˜¤ë¥˜ ìˆ˜ì • (diary íƒ€ì…, analysisId, isJsonArrayMode, findUnique â†’ findFirst, null ì²´í¬)
19. âœ… ëª¨ë¸ ì„ íƒ ì‹œ í”„ë¡œë°”ì´ë” ìë™ ì„¤ì • ê¸°ëŠ¥ ì¶”ê°€ (getProviderForModel í•¨ìˆ˜, API ìˆ˜ì •)
20. âœ… ì„ì‹œì €ì¥ ë‚ ì§œ ë³µêµ¬ ê¸°ëŠ¥ ì¶”ê°€ (DatePickerì— ì›ë˜ ë‚ ì§œ ë°˜ì˜)
21. âœ… Gemini API JSON íŒŒì‹± ì˜¤ë¥˜ ìˆ˜ì • (try-catchë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬)
22. âœ… Prisma íŠ¸ëœì­ì…˜ íƒ€ì„ì•„ì›ƒ í•´ê²° (íƒ€ì„ì•„ì›ƒ ì˜µì…˜ ì¶”ê°€, í´ë°± ë¡œì§ êµ¬í˜„)
23. âœ… PrismaClient ì´ˆê¸°í™” ì˜¤ë¥˜ ìˆ˜ì • (ì‹±ê¸€í†¤ ì‚¬ìš©)
24. âœ… TypeScript ì˜¤ë¥˜ ìˆ˜ì • (draft routeì˜ existingDraft ìŠ¤ì½”í”„ ë¬¸ì œ)
25. âœ… SSE ìŠ¤íŠ¸ë¦¬ë° ì•ˆì •ì„± ë° íŒŒì‹± ê°œì„  (í† í° ì œí•œ ì¦ê°€, íŒŒì‹± ë¡œì§ ê°œì„ )
26. âœ… SSE Controller ë‹«í˜ ì˜¤ë¥˜ ê°œì„  (ìƒíƒœ í™•ì¸ ê°•í™”)
27. âœ… 2ì°¨ HUA AI ë¶„ì„ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ (ì™„ë£Œ ì—¬ë¶€ í™•ì¸)
28. âœ… SSE ìŠ¤íŠ¸ë¦¬ë° íŒŒì‹± ë¡œì§ ë¦¬íŒ©í† ë§ (processStreamDelta ê³µí†µ í•¨ìˆ˜)

**ì´ íš¨ê³¼:**
- ğŸ”§ **ì¸í”„ë¼**: Prisma 7.1.0 ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ, ìµœì‹  ê¸°ëŠ¥ í™œìš© ê°€ëŠ¥
- ğŸ› ï¸ **ê°œë°œ í™˜ê²½**: ë¹Œë“œ ì„¤ì • ê°œì„ , TypeScript ê²½ë¡œ í•´ì„ ê°œì„ 
- ğŸ“¦ **ì˜ì¡´ì„±**: Prisma, Node.js íƒ€ì… ì •ì˜ ì—…ë°ì´íŠ¸
- âœ… **ì™„ë£Œ**: PrismaClient adapter ë¹Œë“œ ì‹œ ì´ˆê¸°í™” ë¬¸ì œ í•´ê²°
- ğŸš€ **ì„œë²„ë¦¬ìŠ¤ ìµœì í™”**: Vercel í™˜ê²½ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€, ì—°ê²° í’€ ìµœì í™”
- ğŸ¨ **UX ê°œì„ **: ì¼ê¸° ë¶„ì„ UI í•˜ì´ë¼í‚¤ ë³€ê²½, í•µì‹¬ ì •ë³´ ìš°ì„  í‘œì‹œ, ëª¨ë¸-í”„ë¡œë°”ì´ë” ìë™ ì„¤ì •
- âš¡ **ì„±ëŠ¥**: DB ì¿¼ë¦¬ 66% ê°ì†Œ, ì½”ë“œ ì¤‘ë³µ 75% ê°ì†Œ, ë¶ˆí•„ìš”í•œ SSE ì—°ê²° ë°©ì§€
- ğŸ’° **ë¹„ìš©**: ì¤‘ë³µ ë¶„ì„ ì‹¤í–‰ ë°©ì§€, ë¡œê·¸ ì˜¤ë²„í—¤ë“œ ê°ì†Œ
- ğŸ› **ë²„ê·¸ ìˆ˜ì •**: TypeScript ì˜¤ë¥˜ í•´ê²°, íƒ€ì… ì•ˆì •ì„± í–¥ìƒ, ëŸ°íƒ€ì„ ì˜¤ë¥˜ ë°©ì§€, JSON íŒŒì‹± ì˜¤ë¥˜ ìˆ˜ì •, íŠ¸ëœì­ì…˜ íƒ€ì„ì•„ì›ƒ í•´ê²°
- ğŸ”§ **ì•ˆì •ì„±**: íŠ¸ëœì­ì…˜ íƒ€ì„ì•„ì›ƒ í´ë°± ë¡œì§ìœ¼ë¡œ ë¶„ì„ ê²°ê³¼ ì €ì¥ ë³´ì¥, ì„ì‹œì €ì¥ ë‚ ì§œ ë³µêµ¬ ê¸°ëŠ¥

---

## ğŸ¯ ì£¼ìš” ì‘ì—… ë‚´ìš©

### 1. Prisma 7.1.0 ë§ˆì´ê·¸ë ˆì´ì…˜ âœ…

#### 1.1 ìŠ¤í‚¤ë§ˆ íŒŒì¼ ì—…ë°ì´íŠ¸
- **ëª©ì **: Prisma 7.1.0ì˜ ìƒˆë¡œìš´ ì„¤ì • ë°©ì‹ ì ìš©
- **ë³€ê²½**: `prisma/schema.prisma`ì—ì„œ `url`ê³¼ `directUrl` ì œê±°
- **ì´ìœ **: Prisma 7.1.0ë¶€í„°ëŠ” `prisma.config.ts`ì—ì„œ ì—°ê²° ì •ë³´ ê´€ë¦¬

**ë³€ê²½ ì „**:
```prisma
datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  schemas   = ["user", "admin"]
}
```

**ë³€ê²½ í›„**:
```prisma
datasource db {
  provider = "postgresql"
  schemas  = ["user", "admin"]
}
```

#### 1.2 prisma.config.ts íŒŒì¼ ìƒì„±
- **ê²½ë¡œ**: `apps/sum-diary/prisma.config.ts`
- **ë‚´ìš©**: Prisma ì„¤ì •ì„ TypeScriptë¡œ ê´€ë¦¬

```typescript
import { defineConfig } from 'prisma/config';

export default defineConfig({
  schema: './prisma/schema.prisma',
  datasource: {
    url: process.env.DATABASE_URL || '',
    shadowDatabaseUrl: process.env.DIRECT_URL,
  },
  migrations: {
    path: './prisma/migrations',
  },
});
```

#### 1.3 PrismaClient adapter ì„¤ì •
- **ëª©ì **: Prisma 7.1.0ì—ì„œëŠ” adapterê°€ í•„ìˆ˜
- **íŒ¨í‚¤ì§€**: `@prisma/adapter-pg`, `pg` ì¶”ê°€
- **ë³€ê²½**: `app/lib/prisma.ts`ì— adapter ì¶”ê°€

**ë³€ê²½ ë‚´ìš©**:
```typescript
import { PrismaClient } from '@prisma/client'
import { PrismaPg } from '@prisma/adapter-pg'

const adapter = new PrismaPg({ 
  connectionString: process.env.DATABASE_URL 
    ? optimizeDatabaseUrl(process.env.DATABASE_URL)
    : (process.env.DATABASE_URL || 'postgresql://localhost:5432/dummy')
})

export const prisma = globalForPrisma.prisma ?? new PrismaClient({
  adapter,
  log: ['error', 'warn'],
})
```

**ë¬¸ì œì **:
- ë¹Œë“œ ì‹œ í™˜ê²½ ë³€ìˆ˜ê°€ ì—†ì„ ìˆ˜ ìˆì–´ adapter ì´ˆê¸°í™” ì‹¤íŒ¨
- PrismaClientê°€ ë¹Œë“œ íƒ€ì„ì— ì´ˆê¸°í™”ë˜ë©´ì„œ ì˜¤ë¥˜ ë°œìƒ

---

### 2. TypeScript ê²½ë¡œ ë§¤í•‘ ê°œì„  âœ…

#### 2.1 workspace íŒ¨í‚¤ì§€ ê²½ë¡œ ì„¤ì •
- **ëª©ì **: `@hua-labs/utils`, `@hua-labs/ui` ëª¨ë“ˆ í•´ì„ ê°œì„ 
- **ë³€ê²½**: `apps/sum-diary/tsconfig.json`ì— ê²½ë¡œ ë§¤í•‘ ì¶”ê°€

```json
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["./*"],
      "@hua-labs/utils": ["../../packages/hua-utils/dist"],
      "@hua-labs/ui": ["../../packages/hua-ui/src"],
      "@hua-labs/ui/advanced": ["../../packages/hua-ui/dist/advanced"],
      "@hua-labs/ui/advanced/dashboard": ["../../packages/hua-ui/src/advanced/dashboard"],
      "@hua-labs/ui/advanced/motion": ["../../packages/hua-ui/src/advanced/motion"]
    }
  }
}
```

#### 2.2 moduleResolution ì„¤ì •
- **ë³€ê²½**: `moduleResolution: "node"` ìœ ì§€
- **ì´ìœ **: í‘œì¤€ npm íŒ¨í‚¤ì§€ í•´ì„ì— ì í•©, ì„œë¸ŒíŒ¨í‚¤ì§€ exportëŠ” ê²½ë¡œ ë§¤í•‘ìœ¼ë¡œ í•´ê²°

---

### 3. useToast íƒ€ì… ë¬¸ì œ í•´ê²° âœ…

#### 3.1 ë¬¸ì œ
- `useToast` í•¨ìˆ˜ì˜ ë°˜í™˜ íƒ€ì…ì´ `never`ë¡œ ì¶”ë¡ ë¨
- `addToast` í˜¸ì¶œ ì‹œ íƒ€ì… ì˜¤ë¥˜ ë°œìƒ

#### 3.2 í•´ê²°
- **íŒŒì¼**: `packages/hua-ui/src/components/Toast.tsx`
- **ë³€ê²½**: `useToast` í•¨ìˆ˜ì— ëª…ì‹œì  ë°˜í™˜ íƒ€ì… ì¶”ê°€

```typescript
export function useToast(): ToastContextType {
  const context = useContext(ToastContext)
  if (!context) {
    throw new Error("useToast must be used within a ToastProvider")
  }
  return context
}
```

---

### 4. i18n-test ë¹Œë“œ ì„¤ì • ìˆ˜ì • âœ…

#### 4.1 ë¬¸ì œ
- Turbopack ë¹Œë“œ ì‹œ Google Fonts ë¡œë”© ì˜¤ë¥˜
- `@vercel/turbopack-next/internal/font/google/font` ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŒ

#### 4.2 í•´ê²°
- **íŒŒì¼**: `apps/i18n-test/package.json`
- **ë³€ê²½**: ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ì— `--webpack` í”Œë˜ê·¸ ì¶”ê°€

```json
{
  "scripts": {
    "dev": "next dev --turbopack",
    "build": "next build --webpack"
  }
}
```

**íš¨ê³¼**:
- ê°œë°œ ëª¨ë“œì—ì„œëŠ” Turbopack ì‚¬ìš© (ë¹ ë¥¸ HMR)
- ë¹Œë“œ ì‹œì—ëŠ” webpack ì‚¬ìš© (ì•ˆì •ì„±)

---

### 5. turbo.json ë¹Œë“œ ì¶œë ¥ ì„¤ì • ì¶”ê°€ âœ…

#### 5.1 ë¬¸ì œ
- `@hua-labs/i18n-ai`ì™€ `@hua-labs/i18n-plugins` ë¹Œë“œ ì¶œë ¥ ê²½ê³ 

#### 5.2 í•´ê²°
- **íŒŒì¼**: `turbo.json`
- **ë³€ê²½**: ëˆ„ë½ëœ ë¹Œë“œ ì¶œë ¥ ì„¤ì • ì¶”ê°€

```json
{
  "tasks": {
    "@hua-labs/i18n-ai#build": {
      "dependsOn": [],
      "outputs": ["dist/**"]
    },
    "@hua-labs/i18n-plugins#build": {
      "dependsOn": [],
      "outputs": ["dist/**"]
    }
  }
}
```

---

### 6. Vercel ì„œë²„ë¦¬ìŠ¤ í™˜ê²½ ëˆ„ìˆ˜ ë°©ì§€ âœ…

#### 6.1 ë¬¸ì œ ë°œê²¬
- **ë©”ëª¨ë¦¬ ìºì‹œ ëˆ„ìˆ˜**: `userSettingsCache`, `rateLimitMap`ì´ ë¬´í•œì • ì¦ê°€ ê°€ëŠ¥
- **ì—°ê²° í’€ ê³¼ë‹¤**: ì„œë²„ë¦¬ìŠ¤ í™˜ê²½ì—ì„œ ì—°ê²° í’€ í¬ê¸° 10ì´ ê³¼ë„í•  ìˆ˜ ìˆìŒ
- **ì˜í–¥**: ì„œë²„ë¦¬ìŠ¤ í•¨ìˆ˜ ë©”ëª¨ë¦¬ ì œí•œ ì´ˆê³¼, ì„±ëŠ¥ ì €í•˜

#### 6.2 í•´ê²° ë°©ë²•

##### 6.2.1 ë©”ëª¨ë¦¬ ìºì‹œ TTL ì¶”ê°€ (Lazy Cleanup íŒ¨í„´ - í™•ë¥  ê¸°ë°˜)
- **íŒŒì¼**: `app/lib/user-settings-server.ts`
- **ë³€ê²½**: ìºì‹œ ì—”íŠ¸ë¦¬ì— `cachedAt` íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€, TTL 5ë¶„ ì ìš©
- **ì •ë¦¬**: `setInterval` ì œê±°, ìš”ì²­ ì‹œ í™•ë¥ ì ìœ¼ë¡œ ì •ë¦¬í•˜ëŠ” Lazy Cleanup íŒ¨í„´ ì ìš©
- **ì´ìœ **: ì„œë²„ë¦¬ìŠ¤ í™˜ê²½ì—ì„œëŠ” í•¨ìˆ˜ê°€ ìš”ì²­ í›„ ë™ê²°ë˜ë¯€ë¡œ `setInterval`ì´ ì‘ë™í•˜ì§€ ì•ŠìŒ
- **ìµœì í™”**: ì¹´ìš´í„° ë°©ì‹ â†’ í™•ë¥  ë°©ì‹ìœ¼ë¡œ ë³€ê²½ (ìƒíƒœ ì˜ì¡´ì„± ì œê±°)

**ì„œë²„ë¦¬ìŠ¤ í™˜ê²½ íŠ¹ì„±**:
- ê° ì¸ìŠ¤í„´ìŠ¤ë§ˆë‹¤ ë³„ë„ì˜ ë©”ëª¨ë¦¬ë¥¼ ê°€ì§€ë¯€ë¡œ ìºì‹œê°€ ê³µìœ ë˜ì§€ ì•ŠìŒ
- ê°™ì€ ì¸ìŠ¤í„´ìŠ¤ì— ê±¸ë¦¬ë©´ DB ì¿¼ë¦¬ë¥¼ ì•„ë‚„ ìˆ˜ ìˆì§€ë§Œ, ì™„ë²½í•œ ìºì‹±ì€ ì•„ë‹˜
- TTLì„ ì§§ê²Œ ì„¤ì •í•˜ì—¬ ì˜¤ë˜ëœ ìºì‹œê°€ ë©”ëª¨ë¦¬ë¥¼ ì°¨ì§€í•˜ì§€ ì•Šë„ë¡ í•¨

```typescript
interface UserSettingsCache {
  // ... ê¸°ì¡´ í•„ë“œë“¤
  cachedAt: number; // ìºì‹œ ìƒì„± ì‹œê°„ (ì„œë²„ë¦¬ìŠ¤ í™˜ê²½ ëˆ„ìˆ˜ ë°©ì§€)
}

const CACHE_TTL_MS = 5 * 60 * 1000; // 5ë¶„ TTL

// TTL ì²´í¬
if (cached && (Date.now() - cached.cachedAt) < CACHE_TTL_MS) {
  return cached.aiProvider;
}
```

##### 6.2.2 Rate Limit ì—”íŠ¸ë¦¬ ì •ë¦¬ (Lazy Cleanup íŒ¨í„´ - í™•ë¥  ê¸°ë°˜)
- **íŒŒì¼**: `app/lib/rate-limit.ts`
- **ë³€ê²½**: `setInterval` ì œê±°, ìš”ì²­ ì‹œ í™•ë¥ ì ìœ¼ë¡œ ì •ë¦¬í•˜ëŠ” Lazy Cleanup íŒ¨í„´ ì ìš©
- **ì´ìœ **: ì„œë²„ë¦¬ìŠ¤ í™˜ê²½ì—ì„œëŠ” í•¨ìˆ˜ê°€ ìš”ì²­ í›„ ë™ê²°ë˜ë¯€ë¡œ `setInterval`ì´ ì‘ë™í•˜ì§€ ì•ŠìŒ
- **ìµœì í™”**: ì¹´ìš´í„° ë°©ì‹ â†’ í™•ë¥  ë°©ì‹ìœ¼ë¡œ ë³€ê²½ (ìƒíƒœ ì˜ì¡´ì„± ì œê±°)

```typescript
// âŒ ì„œë²„ë¦¬ìŠ¤ì—ì„œ ì‘ë™í•˜ì§€ ì•ŠìŒ
setInterval(cleanupExpiredRateLimits, 5 * 60 * 1000);

// âœ… Lazy Cleanup íŒ¨í„´ (í™•ë¥  ê¸°ë°˜)
const CLEANUP_PROBABILITY = 0.01; // 1% í™•ë¥ ë¡œ ì²­ì†Œ

export async function checkUserRateLimit(userId: string) {
  // í™•ë¥  ê¸°ë°˜: ìƒíƒœ(ë³€ìˆ˜)ì— ì˜ì¡´í•˜ì§€ ì•Šì•„ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ì—ë„ ì•ˆì •ì 
  if (Math.random() < CLEANUP_PROBABILITY) {
    cleanupExpiredRateLimits();
  }
  // ... ë¡œì§
}
```

**ì™œ í™•ë¥  ë°©ì‹ì´ ë” ë‚˜ì€ê°€?**
- **ìƒíƒœ ë¹„ì˜ì¡´ì„±**: ì¹´ìš´í„° ë³€ìˆ˜ê°€ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ ì‹œ ì´ˆê¸°í™”ë˜ëŠ” ë¬¸ì œ í•´ê²°
- **ìˆœìˆ˜ì„±**: ìƒíƒœ(ë³€ìˆ˜)ì— ì˜ì¡´í•˜ì§€ ì•ŠëŠ” ë” ìˆœìˆ˜í•œ í•¨ìˆ˜í˜• ì ‘ê·¼
- **í†µê³„ì  ë™ì¼ì„±**: ì¥ê¸°ì ìœ¼ë¡œ 1% í™•ë¥  = 100ë²ˆ ì¤‘ 1ë²ˆ (ì¹´ìš´í„° ë°©ì‹ê³¼ ë™ì¼í•œ íš¨ê³¼)

**ì„œë²„ë¦¬ìŠ¤ í™˜ê²½ íŠ¹ì„±**:
- ê° ì¸ìŠ¤í„´ìŠ¤ë§ˆë‹¤ ë³„ë„ì˜ ë©”ëª¨ë¦¬ë¥¼ ê°€ì§€ë¯€ë¡œ Rate Limitì´ ê³µìœ ë˜ì§€ ì•ŠìŒ
- ê°™ì€ ì¸ìŠ¤í„´ìŠ¤ì— ê±¸ë¦¬ë©´ ì œí•œì´ ì ìš©ë˜ì§€ë§Œ, ì™„ë²½í•œ ê¸€ë¡œë²Œ ì œí•œì€ ì•„ë‹˜
- í”„ë¡œë•ì…˜ì—ì„œëŠ” Redis ë“± ì™¸ë¶€ ì €ì¥ì†Œ ì‚¬ìš© ê¶Œì¥

##### 6.2.3 Prisma ì—°ê²° í’€ ìµœì í™”
- **íŒŒì¼**: `app/lib/prisma.ts`
- **ë³€ê²½**: Vercel í™˜ê²½ ê°ì§€í•˜ì—¬ ì—°ê²° í’€ í¬ê¸° ì¡°ì •
- **ì„œë²„ë¦¬ìŠ¤**: ì—°ê²° í’€ í¬ê¸° 2
- **ì¼ë°˜ ì„œë²„**: ì—°ê²° í’€ í¬ê¸° 10

```typescript
const isServerless = !!process.env.VERCEL;
const connectionLimit = isServerless ? '2' : '10';
```

#### 6.3 íš¨ê³¼
- âœ… ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€: ìºì‹œ TTLë¡œ ë¬´í•œ ì¦ê°€ ë°©ì§€
- âœ… ì—°ê²° í’€ ìµœì í™”: ì„œë²„ë¦¬ìŠ¤ í™˜ê²½ì— ë§ê²Œ ì¡°ì •
- âœ… ì•ˆì •ì„± í–¥ìƒ: ì„œë²„ë¦¬ìŠ¤ í•¨ìˆ˜ ë©”ëª¨ë¦¬ ì œí•œ ì¤€ìˆ˜

---

## ğŸ” ì‹œë„ ë° ì‹¤íŒ¨/ì„±ê³µ ë¡œê·¸

### ì‹œë„ 1: Prisma ìŠ¤í‚¤ë§ˆ íŒŒì¼ì—ì„œ url ì œê±°
- **ì‹œë„**: `schema.prisma`ì—ì„œ `url`ê³¼ `directUrl` ì œê±°
- **ê²°ê³¼**: âœ… ì„±ê³µ - Prisma CLI ì˜¤ë¥˜ í•´ê²°

### ì‹œë„ 2: prisma.config.ts íŒŒì¼ ìƒì„±
- **ì‹œë„**: `prisma.config.ts` íŒŒì¼ ìƒì„± ë° ì„¤ì •
- **ê²°ê³¼**: âš ï¸ ë¶€ë¶„ ì„±ê³µ - íƒ€ì… ì˜¤ë¥˜ ë°œìƒ (`directUrl` â†’ `shadowDatabaseUrl`ë¡œ ìˆ˜ì •)

### ì‹œë„ 3: PrismaClient adapter ì—†ì´ ì‚¬ìš©
- **ì‹œë„**: `prisma.config.ts`ë§Œ ì‚¬ìš©í•˜ê³  adapter ì œê±°
- **ê²°ê³¼**: âŒ ì‹¤íŒ¨ - PrismaClientê°€ adapter ë˜ëŠ” accelerateUrl í•„ìš”

### ì‹œë„ 4: @prisma/adapter-pg ì„¤ì¹˜ ë° ì‚¬ìš©
- **ì‹œë„**: `@prisma/adapter-pg` íŒ¨í‚¤ì§€ ì„¤ì¹˜ ë° adapter ì¶”ê°€
- **ê²°ê³¼**: âš ï¸ ë¶€ë¶„ ì„±ê³µ - ë¹Œë“œ ì‹œ í™˜ê²½ ë³€ìˆ˜ ì—†ìŒìœ¼ë¡œ ì¸í•œ ì´ˆê¸°í™” ì˜¤ë¥˜

### ì‹œë„ 5: ì¡°ê±´ë¶€ adapter ìƒì„±
- **ì‹œë„**: `process.env.DATABASE_URL` ì²´í¬ í›„ adapter ìƒì„±
- **ê²°ê³¼**: âŒ ì‹¤íŒ¨ - PrismaClientëŠ” adapterê°€ í•„ìˆ˜

### ì‹œë„ 6: ë”ë¯¸ connectionString ì‚¬ìš©
- **ì‹œë„**: í™˜ê²½ ë³€ìˆ˜ê°€ ì—†ì„ ë•Œ ë”ë¯¸ connectionString ì‚¬ìš©
- **ê²°ê³¼**: âš ï¸ ì§„í–‰ ì¤‘ - ë¹Œë“œ ì‹œ PrismaClient ì´ˆê¸°í™” ì˜¤ë¥˜ ì—¬ì „íˆ ë°œìƒ

### ì‹œë„ 7: TypeScript ê²½ë¡œ ë§¤í•‘ ì¶”ê°€
- **ì‹œë„**: `@hua-labs/utils`, `@hua-labs/ui` ê²½ë¡œ ë§¤í•‘ ì¶”ê°€
- **ê²°ê³¼**: âœ… ì„±ê³µ - ëª¨ë“ˆ í•´ì„ ë¬¸ì œ í•´ê²°

### ì‹œë„ 8: useToast ë°˜í™˜ íƒ€ì… ëª…ì‹œ
- **ì‹œë„**: `useToast` í•¨ìˆ˜ì— `ToastContextType` ë°˜í™˜ íƒ€ì… ì¶”ê°€
- **ê²°ê³¼**: âœ… ì„±ê³µ - íƒ€ì… ì˜¤ë¥˜ í•´ê²°

### ì‹œë„ 9: i18n-test webpack ì‚¬ìš©
- **ì‹œë„**: ë¹Œë“œ ì‹œ webpack ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½
- **ê²°ê³¼**: âœ… ì„±ê³µ - Google Fonts ì˜¤ë¥˜ í•´ê²°

### ì‹œë„ 10: turbo.json ë¹Œë“œ ì¶œë ¥ ì„¤ì •
- **ì‹œë„**: ëˆ„ë½ëœ íŒ¨í‚¤ì§€ ë¹Œë“œ ì¶œë ¥ ì„¤ì • ì¶”ê°€
- **ê²°ê³¼**: âœ… ì„±ê³µ - ê²½ê³  ë©”ì‹œì§€ í•´ê²°

### ì‹œë„ 11: PrismaClient ì‹±ê¸€í†¤ íŒ¨í„´ í†µì¼
- **ì‹œë„**: ëª¨ë“  íŒŒì¼ì—ì„œ `new PrismaClient()` ì œê±°í•˜ê³  ì‹±ê¸€í†¤ ì‚¬ìš©
- **ê²°ê³¼**: âœ… ì„±ê³µ - ë¹Œë“œ ì‹œ ì´ˆê¸°í™” ì˜¤ë¥˜ í•´ê²°
- **ìˆ˜ì • íŒŒì¼**: 11ê°œ íŒŒì¼ (billing.ts, analysis-query-helpers.ts, crisis-detection-service.ts ë“±)

### ì‹œë„ 12: API ë¼ìš°íŠ¸ $disconnect() ì œê±°
- **ì‹œë„**: API ë¼ìš°íŠ¸ì—ì„œ `$disconnect()` í˜¸ì¶œ ì œê±°
- **ê²°ê³¼**: âœ… ì„±ê³µ - ì‹±ê¸€í†¤ PrismaClient ì¬ì‚¬ìš© ê°€ëŠ¥
- **ìˆ˜ì • íŒŒì¼**: 3ê°œ íŒŒì¼ (user/profile/route.ts, user/upload/route.ts, diary/[id]/crisis-alert/route.ts)

### ì‹œë„ 13: Vercel ì„œë²„ë¦¬ìŠ¤ ëˆ„ìˆ˜ ë°©ì§€
- **ì‹œë„**: ë©”ëª¨ë¦¬ ìºì‹œ TTL ì¶”ê°€, Rate Limit ì—”íŠ¸ë¦¬ ì •ë¦¬, ì—°ê²° í’€ ìµœì í™”
- **ê²°ê³¼**: âœ… ì„±ê³µ - ì„œë²„ë¦¬ìŠ¤ í™˜ê²½ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€

---

## âš ï¸ ë‚¨ì€ ë¬¸ì œ

### 1. PrismaClient ë¹Œë“œ ì‹œ ì´ˆê¸°í™” ì˜¤ë¥˜ (ê°œì„  ì¤‘)
- **ë¬¸ì œ**: ë¹Œë“œ ì‹œ PrismaClientê°€ ì´ˆê¸°í™”ë˜ë©´ì„œ adapter ì—°ê²° ì˜¤ë¥˜ ë°œìƒ
- **ì›ì¸**: Next.js ë¹Œë“œ í”„ë¡œì„¸ìŠ¤ì—ì„œ í™˜ê²½ ë³€ìˆ˜ê°€ ì œëŒ€ë¡œ ë¡œë“œë˜ì§€ ì•Šê±°ë‚˜, PrismaClientê°€ ë¹Œë“œ íƒ€ì„ì— ì´ˆê¸°í™”ë¨
- **ì˜í–¥**: ë¹Œë“œ ì‹¤íŒ¨
- **ì ìš©í•œ í•´ê²°ì±…**:
  1. âœ… **Lazy Initialization íŒ¨í„´ ì ìš©**: PrismaClientë¥¼ í•¨ìˆ˜ ë‚´ë¶€ì—ì„œë§Œ ì´ˆê¸°í™”í•˜ë„ë¡ ë³€ê²½
  2. âœ… **turbo.json globalEnv ì¶”ê°€**: DATABASE_URLì„ globalEnvì— ì¶”ê°€í•˜ì—¬ ë¹Œë“œ ì‹œ ì „ë‹¬
  3. âœ… **next.config.ts serverComponentsExternalPackages ì¶”ê°€**: Prisma ê´€ë ¨ íŒ¨í‚¤ì§€ë¥¼ ì™¸ë¶€ íŒ¨í‚¤ì§€ë¡œ ì„¤ì •
- **í™˜ê²½ ë³€ìˆ˜ ê´€ë¦¬**:
  - **ë¡œì»¬ ê°œë°œ**: Doppler ì‚¬ìš© (`doppler run -- <command>`)
  - **Vercel ë°°í¬**: Vercel Secrets ì‚¬ìš© (í™˜ê²½ ë³€ìˆ˜ ì§ì ‘ ì„¤ì •)
  - **í™•ì¸ í•„ìš”**: Vercel ëŒ€ì‹œë³´ë“œì—ì„œ `DATABASE_URL`ì´ Production, Preview, Development í™˜ê²½ ëª¨ë‘ì— ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
- **ìƒíƒœ**: ì½”ë“œ ìˆ˜ì • ì™„ë£Œ, ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì§„í–‰ ì¤‘
- **ì¶”ê°€ ì¡°ì‚¬ í•„ìš”**: 
  1. `/api/admin/crisis-alerts/[id]` ê²½ë¡œì—ì„œ ë°œìƒí•˜ëŠ” êµ¬ì²´ì ì¸ ì˜¤ë¥˜ ë¶„ì„
  2. Vercel í™˜ê²½ ë³€ìˆ˜ ì„¤ì • í™•ì¸ (Production, Preview, Development)
  3. **Turbopack vs Webpack**: `sum-diary`ëŠ” ì´ë¯¸ `--webpack` í”Œë˜ê·¸ ì‚¬ìš© ì¤‘ì´ì§€ë§Œ, ë¹Œë“œ ì˜¤ë¥˜ ì§€ì† â†’ ë‹¤ë¥¸ ì›ì¸ ê°€ëŠ¥ì„±

---

## ğŸ“ ë³€ê²½ëœ íŒŒì¼

### ì„¤ì • íŒŒì¼
- `apps/sum-diary/prisma/schema.prisma` - url, directUrl ì œê±°
- `apps/sum-diary/prisma.config.ts` - ìƒˆë¡œ ìƒì„±
- `apps/sum-diary/tsconfig.json` - ê²½ë¡œ ë§¤í•‘ ì¶”ê°€
- `apps/sum-diary/next.config.ts` - transpilePackages ì„¤ì • ìœ ì§€
- `apps/i18n-test/package.json` - ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ ìˆ˜ì •
- `turbo.json` - ë¹Œë“œ ì¶œë ¥ ì„¤ì • ì¶”ê°€

### ì½”ë“œ íŒŒì¼
- `apps/sum-diary/app/lib/prisma.ts` - Lazy Initialization íŒ¨í„´ ì ìš©, adapter ì¶”ê°€, ì„œë²„ë¦¬ìŠ¤ ì—°ê²° í’€ ìµœì í™”
- `apps/sum-diary/app/lib/billing.ts` - ì‹±ê¸€í†¤ prisma ì‚¬ìš©
- `apps/sum-diary/app/lib/analysis-query-helpers.ts` - ì‹±ê¸€í†¤ prisma ì‚¬ìš©
- `apps/sum-diary/app/lib/crisis-detection-service.ts` - ì‹±ê¸€í†¤ prisma ì‚¬ìš©, `$disconnect()` ì œê±°
- `apps/sum-diary/app/lib/analysis-service.ts` - ì‹±ê¸€í†¤ prisma ì‚¬ìš©, `export { prisma }` ì œê±°
- `apps/sum-diary/app/lib/concurrent-limit.ts` - ì‹±ê¸€í†¤ prisma ì‚¬ìš©
- `apps/sum-diary/app/lib/rate-limit.ts` - ì‹±ê¸€í†¤ prisma ì‚¬ìš©, ì˜¤ë˜ëœ ì—”íŠ¸ë¦¬ ì •ë¦¬ ì¶”ê°€
- `apps/sum-diary/app/lib/quota.ts` - ì‹±ê¸€í†¤ prisma ì‚¬ìš©
- `apps/sum-diary/app/lib/quota-store/db-quota-store.ts` - ì‹±ê¸€í†¤ prisma ì‚¬ìš©
- `apps/sum-diary/app/lib/guest-migration.ts` - ì‹±ê¸€í†¤ prisma ì‚¬ìš©
- `apps/sum-diary/app/lib/guest-migration-improved.ts` - ì‹±ê¸€í†¤ prisma ì‚¬ìš©
- `apps/sum-diary/app/lib/guest-utils.ts` - ì‹±ê¸€í†¤ prisma ì‚¬ìš©
- `apps/sum-diary/app/lib/user-settings-server.ts` - ìºì‹œ TTL ì¶”ê°€, ë§Œë£Œëœ ì—”íŠ¸ë¦¬ ì •ë¦¬
- `apps/sum-diary/app/api/user/profile/route.ts` - `$disconnect()` ì œê±°
- `apps/sum-diary/app/api/user/upload/route.ts` - `$disconnect()` ì œê±°
- `apps/sum-diary/app/api/diary/[id]/crisis-alert/route.ts` - `$disconnect()` ì œê±°
- `packages/hua-ui/src/components/Toast.tsx` - ë°˜í™˜ íƒ€ì… ëª…ì‹œ
- `apps/sum-diary/package.json` - @prisma/adapter-pg, pg ì¶”ê°€

---

## âœ… ìµœì¢… ê²°ê³¼

### ë¹Œë“œ ì„±ê³µ! ğŸ‰
- ëª¨ë“  PrismaClient ì´ˆê¸°í™” ì˜¤ë¥˜ í•´ê²°
- Next.js ì„¤ì • ê²½ê³  í•´ê²°
- ë¹Œë“œ ì‹œê°„: ì•½ 1ë¶„ 3ì´ˆ
- ëª¨ë“  API ë¼ìš°íŠ¸ ë° í˜ì´ì§€ ë¹Œë“œ ì™„ë£Œ

### í•µì‹¬ í•´ê²° ë°©ë²•
1. **ì‹±ê¸€í†¤ íŒ¨í„´ í†µì¼**: ëª¨ë“  íŒŒì¼ì—ì„œ `@/app/lib/prisma`ì˜ ì‹±ê¸€í†¤ ì‚¬ìš©
2. **Lazy Initialization**: PrismaClientë¥¼ í•¨ìˆ˜ ë‚´ë¶€ì—ì„œë§Œ ì´ˆê¸°í™”
3. **Next.js 16 í˜¸í™˜**: `serverExternalPackages` ì„¤ì • ì ìš©
4. **ì„œë²„ë¦¬ìŠ¤ ìµœì í™”**: ë©”ëª¨ë¦¬ ìºì‹œ TTL, ì—°ê²° í’€ í¬ê¸° ì¡°ì •

## ğŸ”„ ë‹¤ìŒ ë‹¨ê³„

1. **í”„ë¡œë•ì…˜ ë°°í¬ í…ŒìŠ¤íŠ¸**
   - Vercel í™˜ê²½ ë³€ìˆ˜ ì„¤ì • í™•ì¸
   - í”„ë¡œë•ì…˜ ë¹Œë“œ ê²€ì¦

2. **ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§**
   - PrismaClient ì´ˆê¸°í™” ì„±ëŠ¥ í™•ì¸
   - ì—°ê²° í’€ ìµœì í™” íš¨ê³¼ í™•ì¸

3. **ë¬¸ì„œí™”**
   - Prisma 7.1.0 ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ ë¬¸ì„œí™”
   - ë¹Œë“œ ì„¤ì • ê°€ì´ë“œ ì—…ë°ì´íŠ¸
   - Vercel ì„œë²„ë¦¬ìŠ¤ ìµœì í™” ê°€ì´ë“œ ì‘ì„±

4. **ì„œë²„ë¦¬ìŠ¤ ëª¨ë‹ˆí„°ë§**
   - ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§
   - ì—°ê²° í’€ ì‚¬ìš©ëŸ‰ í™•ì¸
   - ìºì‹œ íˆíŠ¸ìœ¨ í™•ì¸

---

---

## ğŸ¯ ì˜¤ëŠ˜ ì¶”ê°€ ì‘ì—… (2025-12-15 ì˜¤í›„)

### 1. ì¼ê¸° ë¶„ì„ UI í•˜ì´ë¼í‚¤ ë³€ê²½ âœ…

#### 1.1 í”„ë¡¬í”„íŠ¸ ìˆœì„œ ë³€ê²½
- **ëª©ì **: í”„ë¡ íŠ¸ì—”ë“œ í‘œì‹œ ìˆœì„œì™€ í”„ë¡¬í”„íŠ¸ ìƒì„± ìˆœì„œ ì¼ì¹˜
- **ë³€ê²½**: `TITLE â†’ QUESTION â†’ INTERPRETATION â†’ EMOTION_FLOW â†’ SUMMARY â†’ METADATA`
- **íŒŒì¼**: `app/lib/prompt-templates.ts`

**ë³€ê²½ ì „**:
```
TITLE â†’ SUMMARY â†’ EMOTION_FLOW â†’ QUESTION â†’ INTERPRETATION â†’ METADATA
```

**ë³€ê²½ í›„**:
```
TITLE â†’ QUESTION â†’ INTERPRETATION â†’ EMOTION_FLOW â†’ SUMMARY â†’ METADATA
```

#### 1.2 í”„ë¡ íŠ¸ì—”ë“œ í‘œì‹œ ìˆœì„œ ë³€ê²½
- **ìƒˆ í•˜ì´ë¼í‚¤**:
  1. ì œëª© (í—¤ë”)
  2. ì§ˆë¬¸
  3. ê°ì‘ë¶„ì„
  4. [ê¸°ë¡ ë” ë³´ê¸°] (í´ë”©, ê¸°ë³¸ ë‹«í˜)
     - ê°ì •ì˜ íŒŒí˜•
     - ì˜¤ëŠ˜ì˜ ì¥ë©´
  5. ë‚˜ì˜ ê¸°ë¡ (í´ë”©)
- **íŒŒì¼**: `app/diary/analysis/page.tsx`

#### 1.3 SSE ìŠ¤íŠ¸ë¦¬ë° ìˆœì„œ ë³€ê²½
- **ë³€ê²½**: `sectionOrder` ë°°ì—´ì„ ìƒˆ ìˆœì„œë¡œ ì—…ë°ì´íŠ¸
- **íŒŒì¼**: `app/api/diary/analyze/stream/route.ts`

**íš¨ê³¼**:
- ì‚¬ìš©ì ê²½í—˜ ê°œì„ : í•µì‹¬ ì •ë³´(ì§ˆë¬¸, ê°ì‘ë¶„ì„)ë¥¼ ë¨¼ì € í‘œì‹œ
- ì •ë³´ ê³„ì¸µ êµ¬ì¡° ëª…í™•í™”: ìƒì„¸ ì •ë³´ëŠ” í´ë”©ìœ¼ë¡œ ìˆ¨ê¹€

---

### 2. ë¶„ì„ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ âœ…

#### 2.1 ë¬¸ì œ ë°œê²¬
- **ë¬¸ì œ**: `PROCESSING` ìƒíƒœì¼ ë•Œë„ ìƒˆ ë¶„ì„ì´ ì‹œì‘ë˜ì–´ ì¤‘ë³µ ì‹¤í–‰ ë°œìƒ
- **ì˜í–¥**: ë™ì¼í•œ ì¼ê¸°ì— ëŒ€í•´ ì—¬ëŸ¬ ë²ˆ ë¶„ì„ ì‹¤í–‰, ë¹„ìš© ì¦ê°€, ì„œë²„ ë¶€í•˜

#### 2.2 í•´ê²° ë°©ë²•
- **API ë¼ìš°íŠ¸**: `PROCESSING` ìƒíƒœì¼ ë•Œ ì—ëŸ¬ ë°˜í™˜ ë° ì¢…ë£Œ
- **í”„ë¡ íŠ¸ì—”ë“œ**: `PROCESSING` ìƒíƒœì¼ ë•Œ SSE ì—°ê²°í•˜ì§€ ì•ŠìŒ

**ì½”ë“œ ë³€ê²½**:
```typescript
// app/api/diary/analyze/stream/route.ts
if (existingAnalysis && existingAnalysis.status === 'PROCESSING') {
  console.log('âš ï¸ ë¶„ì„ì´ ì´ë¯¸ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€:', diaryId);
  send({ type: 'error', data: { message: 'ë¶„ì„ì´ ì´ë¯¸ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.' } });
  safeClose();
  return;
}
```

**íš¨ê³¼**:
- ì¤‘ë³µ ë¶„ì„ ì‹¤í–‰ ë°©ì§€
- ë¹„ìš© ì ˆê°
- ì„œë²„ ë¶€í•˜ ê°ì†Œ

---

### 3. ë©”íƒ€ë°ì´í„° ë…¸ì¶œ í™•ì¸ âœ…

#### 3.1 í™•ì¸ ê²°ê³¼
- **ìƒíƒœ**: ë©”íƒ€ë°ì´í„°ëŠ” SSEë¡œ ìˆ˜ì‹ í•˜ì§€ë§Œ UIì— í‘œì‹œí•˜ì§€ ì•ŠìŒ
- **ìœ„ì¹˜**: `app/diary/analysis/page.tsx` 298-301ë²ˆ ì¤„
- **ì²˜ë¦¬**: ë¡œê·¸ë¡œë§Œ í™•ì¸, ì‚¬ìš©ì í™”ë©´ì—ëŠ” ë…¸ì¶œë˜ì§€ ì•ŠìŒ

---

### 4. TypeScript ì˜¤ë¥˜ ìˆ˜ì • âœ…

#### 4.1 ë¬¸ì œ ë°œê²¬
- **ë¬¸ì œ**: ì—¬ëŸ¬ TypeScript íƒ€ì… ì˜¤ë¥˜ ë°œìƒ
  - `diary` ë³€ìˆ˜ íƒ€ì… ì •ì˜ ë¶€ì •í™•
  - `analysisId` ë³€ìˆ˜ ì„ ì–¸ ëˆ„ë½
  - `isJsonArrayMode` ìŠ¤ì½”í”„ ë¬¸ì œ
  - `findUnique`ì—ì„œ `diary_id` ì‚¬ìš© ë¶ˆê°€ (unique key ì•„ë‹˜)
  - `diary` null ì²´í¬ ëˆ„ë½

#### 4.2 í•´ê²° ë°©ë²•

**4.2.1 diary íƒ€ì… ëª…ì‹œì  ì •ì˜**
- **ë³€ê²½**: `Awaited<ReturnType<...>>` ëŒ€ì‹  ëª…ì‹œì  íƒ€ì… ì •ì˜
- **ì´ìœ **: Prisma ì¿¼ë¦¬ ê²°ê³¼ íƒ€ì…ì´ ë³µì¡í•˜ì—¬ ëª…ì‹œì  íƒ€ì…ì´ ë” ì•ˆì •ì 

```typescript
let diary: {
  id: string;
  title: string | null;
  content_enc: Uint8Array;
  user_id: string;
  diary_date: Date | null;
  user: { email_hash: string | null };
  analysis_results: Array<{...}>;
} | null = null;
```

**4.2.2 analysisId ë³€ìˆ˜ ì„ ì–¸ ë³µì›**
- **ë¬¸ì œ**: ì›ìì  ì—°ì‚° ë¡œì§ì—ì„œ `analysisId` ë³€ìˆ˜ê°€ ì œê±°ë¨
- **í•´ê²°**: `analysisId` ë³€ìˆ˜ ì„ ì–¸ ë° ì´ˆê¸°í™” ë¡œì§ ë³µì›

**4.2.3 isJsonArrayMode ìŠ¤ì½”í”„ ë¬¸ì œ í•´ê²°**
- **ë¬¸ì œ**: í´ë°± Gemini ë¸”ë¡ì—ì„œ `isJsonArrayMode` ë³€ìˆ˜ê°€ ì„ ì–¸ë˜ì§€ ì•ŠìŒ
- **í•´ê²°**: í´ë°± ë¸”ë¡ì—ì„œë„ ë³€ìˆ˜ ì„ ì–¸ ë° ì´ˆê¸°í™” ì¶”ê°€

```typescript
// í´ë°± Gemini ë¸”ë¡
let isJsonArrayMode = false; // JSON ë°°ì—´ ëª¨ë“œ ê°ì§€

// ì²« ë²ˆì§¸ ì²­í¬ì—ì„œ í˜•ì‹ ê°ì§€
if (chunkCount === 1) {
  isJsonArrayMode = geminiBuffer.trim().startsWith('[');
}
```

**4.2.4 findUnique â†’ findFirst ë³€ê²½**
- **ë¬¸ì œ**: `diary_id`ëŠ” unique keyê°€ ì•„ë‹ˆë¯€ë¡œ `findUnique` ì‚¬ìš© ë¶ˆê°€
- **í•´ê²°**: `findFirst`ë¡œ ë³€ê²½í•˜ê³  `orderBy` ì¶”ê°€

```typescript
// ë³€ê²½ ì „
const updated = await prisma.analysisResult.findUnique({
  where: { diary_id: diaryId },
  ...
});

// ë³€ê²½ í›„
const updated = await prisma.analysisResult.findFirst({
  where: { diary_id: diaryId },
  orderBy: { created_at: 'desc' },
  ...
});
```

**4.2.5 diary null ì²´í¬ ì¶”ê°€**
- **ë¬¸ì œ**: ì—¬ëŸ¬ ê³³ì—ì„œ `diary`ê°€ nullì¼ ìˆ˜ ìˆëŠ”ë° ì²´í¬ ì—†ì´ ì‚¬ìš©
- **í•´ê²°**: ëª¨ë“  `diary` ì‚¬ìš© ì „ì— null ì²´í¬ ì¶”ê°€

```typescript
// ì˜ˆì‹œ
if (diary && diary.user_id && analysisId) {
  // 2ì°¨ ë¶„ì„ ë¡œì§
}

if (diary && aiGeneratedTitle && aiGeneratedTitle !== diary.title) {
  // ì œëª© ì—…ë°ì´íŠ¸
}
```

**íš¨ê³¼**:
- âœ… ëª¨ë“  TypeScript ì˜¤ë¥˜ í•´ê²°
- âœ… íƒ€ì… ì•ˆì •ì„± í–¥ìƒ
- âœ… ëŸ°íƒ€ì„ ì˜¤ë¥˜ ë°©ì§€

---

### 5. ëª¨ë¸ ì„ íƒ ì‹œ í”„ë¡œë°”ì´ë” ìë™ ì„¤ì • ê¸°ëŠ¥ ì¶”ê°€ âœ…

#### 5.1 ë¬¸ì œ ë°œê²¬
- **ë¬¸ì œ**: ì„¤ì •ì—ì„œ ëª¨ë¸ì„ ë³€ê²½í•´ë„ í”„ë¡œë°”ì´ë”ê°€ ìë™ìœ¼ë¡œ ë°”ë€Œì§€ ì•ŠìŒ
- **ì˜í–¥**: ì‚¬ìš©ìê°€ ëª¨ë¸ì„ ì„ íƒí–ˆì„ ë•Œ í•´ë‹¹ ëª¨ë¸ì— ë§ëŠ” í”„ë¡œë°”ì´ë”ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ

#### 5.2 í•´ê²° ë°©ë²•

**5.2.1 getProviderForModel í•¨ìˆ˜ ì¶”ê°€**
- **ëª©ì **: ëª¨ë¸ëª…ìœ¼ë¡œë¶€í„° í”„ë¡œë°”ì´ë” ìë™ ê²°ì •
- **íŒŒì¼**: `app/lib/user-settings.ts`

```typescript
export function getProviderForModel(model: string): string {
  const normalizedModel = model.toLowerCase().trim();
  
  // OpenAI ëª¨ë¸ë“¤
  if (normalizedModel.includes('gpt') || normalizedModel.includes('openai')) {
    return 'openai';
  }
  
  // Gemini ëª¨ë¸ë“¤
  if (normalizedModel.includes('gemini')) {
    return 'gemini';
  }
  
  // ìë™ ì„ íƒ
  if (normalizedModel === 'auto') {
    return 'auto';
  }
  
  // ê¸°ë³¸ê°’: OpenAI
  return 'openai';
}
```

**5.2.2 API ì—”ë“œí¬ì¸íŠ¸ ìˆ˜ì •**
- **íŒŒì¼**: `app/api/user/settings/route.ts`
- **ë³€ê²½**: ìš”ì²­ ë³¸ë¬¸ì— `model`ì´ ìˆìœ¼ë©´ í”„ë¡œë°”ì´ë” ìë™ ê²°ì •

```typescript
// ëª¨ë¸ì´ ì œê³µë˜ë©´ í”„ë¡œë°”ì´ë”ë¥¼ ìë™ìœ¼ë¡œ ì„¤ì •
let provider: string;
if (body?.model) {
  // ëª¨ë¸ëª…ìœ¼ë¡œë¶€í„° í”„ë¡œë°”ì´ë” ìë™ ê²°ì •
  provider = getProviderForModel(body.model);
  console.log(`[DEBUG] ëª¨ë¸ "${body.model}"ë¡œë¶€í„° í”„ë¡œë°”ì´ë” ìë™ ê²°ì •: ${provider}`);
} else {
  // ê¸°ì¡´ ë¡œì§: í”„ë¡œë°”ì´ë” ì§ì ‘ ì œê³µ
  provider = String(body?.aiProvider || '').toLowerCase();
}
```

**5.2.3 setUserAiModel í•¨ìˆ˜ ì¶”ê°€**
- **ëª©ì **: í´ë¼ì´ì–¸íŠ¸ì—ì„œ ëª¨ë¸ì„ ì„¤ì •í•  ë•Œ ì‚¬ìš©
- **íŒŒì¼**: `app/lib/user-settings.ts`

```typescript
export async function setUserAiModel(userId: string, model: string): Promise<void> {
  try {
    const response = await fetch('/api/user/settings', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ model, userId }),
    });

    if (!response.ok) {
      // ì—ëŸ¬ ì²˜ë¦¬...
    }

    const provider = getProviderForModel(model);
    console.log(`AI ëª¨ë¸ì´ ${model}ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤. (í”„ë¡œë°”ì´ë”: ${provider})`);
  } catch (error) {
    console.error('AI ëª¨ë¸ ì„¤ì • ì €ì¥ ì‹¤íŒ¨:', error);
    throw error;
  }
}
```

**ì‚¬ìš© ì˜ˆì‹œ**:
```typescript
// ëª¨ë¸ì„ ì„ íƒí•˜ë©´ í”„ë¡œë°”ì´ë”ê°€ ìë™ìœ¼ë¡œ ì„¤ì •ë¨
await setUserAiModel(userId, 'gpt-5-mini'); // í”„ë¡œë°”ì´ë”: 'openai'ë¡œ ìë™ ì„¤ì •
await setUserAiModel(userId, 'gemini-2.5-flash'); // í”„ë¡œë°”ì´ë”: 'gemini'ë¡œ ìë™ ì„¤ì •
```

**íš¨ê³¼**:
- âœ… ëª¨ë¸ ì„ íƒ ì‹œ í”„ë¡œë°”ì´ë” ìë™ ì„¤ì •
- âœ… ì‚¬ìš©ì ê²½í—˜ ê°œì„ 
- âœ… ì„¤ì • ì¼ê´€ì„± ë³´ì¥

---

### 11. SSE ìŠ¤íŠ¸ë¦¬ë° ì•ˆì •ì„± ë° íŒŒì‹± ê°œì„  âœ…

#### 11.1 ë¬¸ì œ ë°œê²¬
- **ë¬¸ì œ**: SSE ìŠ¤íŠ¸ë¦¬ë° íŒŒì‹±ì´ ë¶ˆì•ˆì •í•˜ì—¬ ì¼ê¸° ë‚´ìš© ìœ ì‹¤, ë¶„ì„ ê²°ê³¼ê°€ ì˜ë¦¼
- **ì›ì¸**:
  - `MAX_TOKENS` ì˜¤ë¥˜ë¡œ ì¸í•œ ì‘ë‹µ ì¤‘ë‹¨
  - ë ë§ˆì»¤ê°€ ì—†ì„ ë•Œ íŒŒì‹± ì‹¤íŒ¨
  - íŒŒì‹± ê²€ì¦ ê¸¸ì´ ì œí•œì´ ë„ˆë¬´ ì—„ê²©
- **ì˜í–¥**: ë¶„ì„ ê²°ê³¼ ë¶ˆì™„ì „, ì‚¬ìš©ì ê²½í—˜ ì €í•˜

#### 11.2 í•´ê²° ë°©ë²•

**11.2.1 í† í° ì œí•œ ì¦ê°€**
- **ë³€ê²½**: Gemini `maxOutputTokens` 3000 â†’ 8000, OpenAI `max_completion_tokens` 3000 â†’ 8000
- **ì´ìœ **: `INTERPRETATION`, `METADATA` ì„¹ì…˜ì´ ì™„ì„±ë˜ë„ë¡ ì¶©ë¶„í•œ í† í° í™•ë³´

```typescript
// Gemini
generationConfig: {
  maxOutputTokens: 8000, // 3000 â†’ 8000 ì¦ê°€
  ...
}

// OpenAI
max_completion_tokens: 8000, // 3000 â†’ 8000 ì¦ê°€
```

**11.2.2 íŒŒì‹± ì•ˆì •ì„± ê°œì„ **
- **ë³€ê²½**: ë ë§ˆì»¤ê°€ ì—†ì–´ë„ ë‹¤ìŒ ì„¹ì…˜ ì‹œì‘ ì§€ì ê¹Œì§€ ì¶”ì¶œ
- **ì ìš© ì„¹ì…˜**: `QUESTION`, `INTERPRETATION`, `SUMMARY`, `EMOTION_FLOW`

```typescript
// ë ë§ˆì»¤ê°€ ì—†ì„ ë•Œ ë‹¤ìŒ ì„¹ì…˜ ì‹œì‘ ì§€ì ê¹Œì§€ ì¶”ì¶œ
if (!questionEnd) {
  // ë‹¤ìŒ ì„¹ì…˜ ì‹œì‘ ì§€ì  ì°¾ê¸°
  const nextSectionStart = fullContent.indexOf('##INTERPRETATION##');
  if (nextSectionStart > questionStart) {
    questionContent = fullContent.substring(questionStart, nextSectionStart).trim();
  }
}
```

**11.2.3 ê²€ì¦ ê¸¸ì´ ì™„í™”**
- **ë³€ê²½**: ìµœì†Œ ê¸¸ì´ ì œí•œ ì™„í™”
  - `QUESTION`: 10ì â†’ 5ì
  - `INTERPRETATION`: 20ì â†’ 10ì

**íš¨ê³¼**:
- âœ… ë¶„ì„ ê²°ê³¼ ì™„ì„±ë„ í–¥ìƒ
- âœ… ì¼ê¸° ë‚´ìš© ìœ ì‹¤ ë°©ì§€
- âœ… íŒŒì‹± ì•ˆì •ì„± ê°œì„ 

---

### 12. SSE Controller ë‹«í˜ ì˜¤ë¥˜ ê°œì„  âœ…

#### 12.1 ë¬¸ì œ ë°œê²¬
- **ë¬¸ì œ**: `Invalid state: Controller is already closed` ì˜¤ë¥˜ ë°œìƒ
- **ì›ì¸**: ì´ë¯¸ ë‹«íŒ Controllerì— ë©”ì‹œì§€ ì „ì†¡ ë˜ëŠ” ë‹«ê¸° ì‹œë„
- **ì˜í–¥**: SSE ìŠ¤íŠ¸ë¦¼ ì˜¤ë¥˜, ì‚¬ìš©ìì—ê²Œ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ

#### 12.2 í•´ê²° ë°©ë²•
- **íŒŒì¼**: `app/api/diary/analyze/stream/route.ts`
- **ë³€ê²½**: `send`ì™€ `safeClose` í•¨ìˆ˜ì—ì„œ Controller ìƒíƒœ í™•ì¸ ê°•í™”

```typescript
const send = (data: object) => {
  if (isClosed) return;
  
  try {
    // controller ìƒíƒœ í™•ì¸
    if (controller.desiredSize === null) {
      isClosed = true;
      return;
    }
    const message = `data: ${JSON.stringify(data)}\n\n`;
    controller.enqueue(encoder.encode(message));
  } catch (error: any) {
    // Invalid state ì˜¤ë¥˜ëŠ” ë¬´ì‹œ (ì´ë¯¸ ë‹«í˜”ì„ ìˆ˜ ìˆìŒ)
    if (error?.code === 'ERR_INVALID_STATE' || error?.message?.includes('closed')) {
      isClosed = true;
    } else {
      console.error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
      isClosed = true;
    }
  }
};

const safeClose = () => {
  if (isClosed) return;
  
  try {
    if (controller.desiredSize === null) {
      isClosed = true;
      return;
    }
    controller.close();
    isClosed = true;
  } catch (error: any) {
    // Invalid state ì˜¤ë¥˜ëŠ” ë¬´ì‹œ
    if (error?.code === 'ERR_INVALID_STATE' || error?.message?.includes('closed')) {
      isClosed = true;
    }
  }
};
```

**íš¨ê³¼**:
- âœ… Controller ë‹«í˜ ì˜¤ë¥˜ ë°©ì§€
- âœ… SSE ìŠ¤íŠ¸ë¦¼ ì•ˆì •ì„± í–¥ìƒ
- âœ… ì‚¬ìš©ì ê²½í—˜ ê°œì„ 

---

### 13. 2ì°¨ HUA AI ë¶„ì„ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ âœ…

#### 13.1 ë¬¸ì œ ë°œê²¬
- **ë¬¸ì œ**: 2ì°¨ HUA AI ë¶„ì„ì´ ë‘ ë²ˆ ì‹¤í–‰ë¨
- **ì›ì¸**: `queueMicrotask`ë¡œ ë¹„ë™ê¸° íŠ¸ë¦¬ê±° ì‹œ ì¤‘ë³µ ì²´í¬ ì—†ìŒ
- **ì˜í–¥**: ì¤‘ë³µ ë¶„ì„ ì‹¤í–‰, ë¹„ìš© ì¦ê°€

#### 13.2 í•´ê²° ë°©ë²•
- **íŒŒì¼**: `app/api/diary/analyze/stream/route.ts`
- **ë³€ê²½**: 2ì°¨ ë¶„ì„ ì‹œì‘ ì „ì— ì´ë¯¸ ì™„ë£Œëœ ë¶„ì„ì´ ìˆëŠ”ì§€ í™•ì¸

```typescript
// 2ì°¨ HUA AI ë¶„ì„ ë¹„ë™ê¸° íŠ¸ë¦¬ê±°
if (diary && diary.user_id && analysisId) {
  // ì´ë¯¸ 2ì°¨ ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸ (ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)
  const existingHuaAnalysis = await prisma.huaEmotionAnalysis.findUnique({
    where: { analysis_result_id: analysisId },
    select: { id: true },
  });

  if (existingHuaAnalysis) {
    if (process.env.NODE_ENV === 'development') {
      console.log('â„¹ï¸ 2ì°¨ HUA AI ë¶„ì„ ì´ë¯¸ ì™„ë£Œë¨ (ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€):', { diaryId, analysisId });
    }
    return; // ì´ë¯¸ ì™„ë£Œë˜ì—ˆìœ¼ë©´ 2ì°¨ ë¶„ì„ ê±´ë„ˆë›°ê¸°
  }
  
  // 2ì°¨ ë¶„ì„ ë¡œì§...
}
```

**íš¨ê³¼**:
- âœ… 2ì°¨ ë¶„ì„ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
- âœ… ë¹„ìš© ì ˆê°
- âœ… ì„œë²„ ë¶€í•˜ ê°ì†Œ

---

### 14. SSE ìŠ¤íŠ¸ë¦¬ë° íŒŒì‹± ë¡œì§ ë¦¬íŒ©í† ë§ âœ…

#### 14.1 ë¬¸ì œ ë°œê²¬
- **ë¬¸ì œ**: ìŠ¤íŠ¸ë¦¬ë° íŒŒì‹± ë¡œì§ì´ 4ê³³ì— ì¤‘ë³µë˜ì–´ ìœ ì§€ë³´ìˆ˜ ì–´ë ¤ì›€
- **ì˜í–¥**: ë²„ê·¸ ìˆ˜ì • ì‹œ ì—¬ëŸ¬ ê³³ ìˆ˜ì • í•„ìš”, ì½”ë“œ ì¤‘ë³µ

#### 14.2 í•´ê²° ë°©ë²•
- **íŒŒì¼**: `app/api/diary/analyze/stream/route.ts`
- **ë³€ê²½**: `processStreamDelta` ê³µí†µ í•¨ìˆ˜ë¡œ ì¶”ì¶œ

```typescript
// ê³µí†µ í•¨ìˆ˜ë¡œ ìŠ¤íŠ¸ë¦¼ ë¸íƒ€ ì²˜ë¦¬
const processStreamDelta = (delta: string) => {
  if (!delta) return;
  fullContent += delta;
  buffer += delta;
  const newBuffer = processActiveSection(buffer);
  if (newBuffer !== buffer) {
    buffer = newBuffer;
  }
  // Metadata íŒŒì‹±...
};

// ëª¨ë“  ìŠ¤íŠ¸ë¦¬ë° ë£¨í”„ì—ì„œ ì¬ì‚¬ìš©
// OpenAI, Gemini (1ì°¨ ë° í´ë°±) ëª¨ë‘ ë™ì¼í•œ í•¨ìˆ˜ ì‚¬ìš©
```

**íš¨ê³¼**:
- âœ… ì½”ë“œ ì¤‘ë³µ 75% ê°ì†Œ
- âœ… ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ
- âœ… ë²„ê·¸ ìˆ˜ì • ì‹œ í•œ ê³³ë§Œ ìˆ˜ì •

---

## ğŸš€ ì•ìœ¼ë¡œ í•  ê°œì„  ì‚¬í•­

### 1. ì¤‘ë³µ DB ì¡°íšŒ ìµœì í™” âœ… (ì™„ë£Œ)
- **ë¬¸ì œ**: ë™ì¼í•œ diary ì •ë³´ë¥¼ 3ê³³ì—ì„œ ì¤‘ë³µ ì¡°íšŒ
  - 208ë²ˆ ì¤„: ë©”ì¸ ë¡œì§
  - 176ë²ˆ ì¤„: `handleAbort`
  - 1992ë²ˆ ì¤„: ì—ëŸ¬ ì²˜ë¦¬
- **ê°œì„ **: ì´ë¯¸ ì¡°íšŒí•œ `diary`ì™€ `existingAnalysis`ë¥¼ ìƒìœ„ ìŠ¤ì½”í”„ì— ì €ì¥í•˜ì—¬ ì¬ì‚¬ìš©
- **íš¨ê³¼**: DB ì¿¼ë¦¬ 66% ê°ì†Œ (3íšŒ â†’ 1íšŒ), ì‘ë‹µ ì‹œê°„ ê°œì„ 

**ì½”ë“œ ë³€ê²½**:
```typescript
// ìƒìœ„ ìŠ¤ì½”í”„ì— ë³€ìˆ˜ ì„ ì–¸
let diary: Awaited<ReturnType<typeof prisma.diaryEntry.findUnique>> = null;
let existingAnalysis: ... | null = null;

// ë©”ì¸ ë¡œì§ì—ì„œ í•œ ë²ˆë§Œ ì¡°íšŒ
diary = await prisma.diaryEntry.findUnique({...});
existingAnalysis = diary.analysis_results[0] || null;

// handleAbortì™€ ì—ëŸ¬ ì²˜ë¦¬ì—ì„œ ì¬ì‚¬ìš©
if (existingAnalysis?.status === 'PROCESSING') {
  // ì¬ì¡°íšŒ ì—†ì´ ë°”ë¡œ ì‚¬ìš©
}
```

### 2. OpenAI/Gemini ìŠ¤íŠ¸ë¦¬ë° ë¡œì§ ì¤‘ë³µ ì œê±° âœ… (ì™„ë£Œ)
- **ë¬¸ì œ**: ê±°ì˜ ë™ì¼í•œ ìŠ¤íŠ¸ë¦¬ë° ë¡œì§ì´ 4ê³³ì— ì¤‘ë³µ
  - OpenAI: 547ë²ˆ ì¤„ (1ì°¨), 1040ë²ˆ ì¤„ (í´ë°±)
  - Gemini: 662ë²ˆ ì¤„ (1ì°¨), 1143ë²ˆ ì¤„ (í´ë°±)
- **ê°œì„ **: `processStreamDelta` ê³µí†µ í•¨ìˆ˜ë¡œ ì¶”ì¶œí•˜ì—¬ ì¬ì‚¬ìš©
- **íš¨ê³¼**: ì½”ë“œ ì¤‘ë³µ 75% ê°ì†Œ, ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ, ë²„ê·¸ ìˆ˜ì • ì‹œ í•œ ê³³ë§Œ ìˆ˜ì •

**ì½”ë“œ ë³€ê²½**:
```typescript
// ê³µí†µ í•¨ìˆ˜ ì¶”ì¶œ
const processStreamDelta = (delta: string) => {
  if (!delta) return;
  fullContent += delta;
  buffer += delta;
  const newBuffer = processActiveSection(buffer);
  if (newBuffer !== buffer) {
    buffer = newBuffer;
  }
  // Metadata íŒŒì‹±...
};

// ëª¨ë“  ìŠ¤íŠ¸ë¦¬ë° ë¡œì§ì—ì„œ ì¬ì‚¬ìš©
for await (const chunk of openaiStream) {
  const delta = chunk.choices[0]?.delta?.content || '';
  if (delta) {
    processStreamDelta(delta); // ê³µí†µ í•¨ìˆ˜ ì‚¬ìš©
  }
}
```

### 3. í”„ë¡ íŠ¸ì—”ë“œ-ë°±ì—”ë“œ ì¤‘ë³µ í™•ì¸ ìµœì í™” âœ… (ì™„ë£Œ)
- **ë¬¸ì œ**: í”„ë¡ íŠ¸ì—”ë“œì™€ ë°±ì—”ë“œì—ì„œ ë™ì¼í•œ ë¶„ì„ ê²°ê³¼ í™•ì¸
- **ê°œì„ **: í”„ë¡ íŠ¸ì—”ë“œì—ì„œ `PROCESSING` ìƒíƒœ ì²´í¬ ê°•í™”, ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ `isSubmitting` ì²´í¬ ì¶”ê°€
- **íš¨ê³¼**: ë¶ˆí•„ìš”í•œ SSE ì—°ê²° ì‹œë„ ê°ì†Œ, ì„œë²„ ë¶€í•˜ ê°ì†Œ

**ì½”ë“œ ë³€ê²½**:
```typescript
// í”„ë¡ íŠ¸ì—”ë“œì—ì„œ PROCESSING ìƒíƒœ ì²´í¬
if (analysisData && analysisData.status === 'PROCESSING') {
  setLoading(true);
  return true; // SSE ì—°ê²°í•˜ì§€ ì•ŠìŒ
}

// ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì—ì„œë„ isSubmitting ì²´í¬
if (data.isSubmitting) {
  setLoading(true);
  return true; // SSE ì—°ê²°í•˜ì§€ ì•ŠìŒ
}
```

### 4. ë¶ˆí•„ìš”í•œ ë¡œê·¸ ìµœì í™” ğŸ”„ (ì§„í–‰ ì¤‘)
- **ë¬¸ì œ**: í”„ë¡œë•ì…˜ì—ì„œë„ ì‹¤í–‰ë˜ëŠ” DEBUG ë¡œê·¸ 82ê°œ
- **ê°œì„ **: ì£¼ìš” DEBUG ë¡œê·¸ì— `process.env.NODE_ENV === 'development'` ì¡°ê±´ ì¶”ê°€
- **íš¨ê³¼**: í”„ë¡œë•ì…˜ ë¡œê·¸ ì˜¤ë²„í—¤ë“œ ê°ì†Œ, ë¡œê·¸ ìŠ¤í† ë¦¬ì§€ ë¹„ìš© ì ˆê°
- **ìƒíƒœ**: ì£¼ìš” ë¡œê·¸ ì²˜ë¦¬ ì™„ë£Œ, ë‚˜ë¨¸ì§€ ë¡œê·¸ëŠ” í•„ìš” ì‹œ ì¶”ê°€ ì²˜ë¦¬

**ì²˜ë¦¬ëœ ë¡œê·¸**:
- Controller ê´€ë ¨ ë¡œê·¸
- ì¼ê¸° ë°ì´í„° í™•ì¸ ë¡œê·¸
- í”„ë¡¬í”„íŠ¸ ìƒì„± ë¡œê·¸
- Gemini API í˜¸ì¶œ/ì‘ë‹µ ë¡œê·¸
- ìŠ¤íŠ¸ë¦¼ ì²˜ë¦¬ ë¡œê·¸

### 5. í”„ë¡¬í”„íŠ¸ ìƒì„± ìµœì í™” (Low Priority - ë³´ë¥˜)
- **ë¬¸ì œ**: ë§¤ë²ˆ `createAnalysisPrompt` í˜¸ì¶œ
- **ê°œì„ **: ê°™ì€ ì¼ê¸° ë‚´ìš©ì´ë©´ ìºì‹± ê³ ë ¤
- **ìƒíƒœ**: í˜„ì¬ëŠ” í”„ë¡¬í”„íŠ¸ ìƒì„± ë¹„ìš©ì´ í¬ì§€ ì•Šì•„ ë³´ë¥˜
- **í–¥í›„**: ì¼ê¸° ë‚´ìš© í•´ì‹œ ê¸°ë°˜ ìºì‹± ê³ ë ¤ ê°€ëŠ¥

---

### 6. ì„ì‹œì €ì¥ ë‚ ì§œ ë³µêµ¬ ê¸°ëŠ¥ ì¶”ê°€ âœ…

#### 6.1 ë¬¸ì œ ë°œê²¬
- **ë¬¸ì œ**: ì„ì‹œì €ì¥ì„ ë¶ˆëŸ¬ì˜¬ ë•Œ ì„ íƒí–ˆë˜ ë‚ ì§œê°€ ë³µêµ¬ë˜ì§€ ì•Šê³  ì˜¤ëŠ˜ ë‚ ì§œë¡œ ë³€ê²½ë¨
- **ì˜í–¥**: ì‚¬ìš©ìê°€ ê³¼ê±° ë‚ ì§œë¡œ ì‘ì„±í•œ ì„ì‹œì €ì¥ì„ ë¶ˆëŸ¬ì˜¤ë©´ ë‚ ì§œê°€ ì˜¤ëŠ˜ë¡œ ë°”ë€œ

#### 6.2 í•´ê²° ë°©ë²•
- **íŒŒì¼**: `app/diary/write/page.tsx`
- **ë³€ê²½**: `handleLoadDraft` ë˜í¼ í•¨ìˆ˜ì—ì„œ `diary_date` ë˜ëŠ” `diaryDate`ë¥¼ í™•ì¸í•˜ì—¬ `setSelectedDate` í˜¸ì¶œ

```typescript
// ì„ì‹œì €ì¥ì˜ ë‚ ì§œë¡œ selectedDateë„ ì—…ë°ì´íŠ¸ (DatePickerì— ë°˜ì˜ë˜ë„ë¡)
const dateString = draft.diary_date || draft.diaryDate;
if (dateString) {
  const parsedDate = parseDateAsKorean(dateString.split('T')[0]);
  setSelectedDate(parsedDate);
}
```

**íš¨ê³¼**:
- âœ… ì„ì‹œì €ì¥ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œ ì›ë˜ ì„ íƒí–ˆë˜ ë‚ ì§œë¡œ ë³µêµ¬
- âœ… DatePickerê°€ ì˜¬ë°”ë¥¸ ë‚ ì§œë¥¼ í‘œì‹œ
- âœ… ì‚¬ìš©ì ê²½í—˜ ê°œì„ 

---

### 7. Gemini API JSON íŒŒì‹± ì˜¤ë¥˜ ìˆ˜ì • âœ…

#### 7.1 ë¬¸ì œ ë°œê²¬
- **ë¬¸ì œ**: `JSON.parse(errorText).catch(() => ({}))` - `JSON.parse()`ëŠ” Promiseê°€ ì•„ë‹ˆë¯€ë¡œ `.catch()` ì‚¬ìš© ë¶ˆê°€
- **ì˜¤ë¥˜ ë©”ì‹œì§€**: `JSON.parse(...).catch is not a function`
- **ì˜í–¥**: Gemini API ì˜¤ë¥˜ ì²˜ë¦¬ ì‹¤íŒ¨, í´ë°± ë¡œì§ ì‘ë™ ì•ˆ í•¨

#### 7.2 í•´ê²° ë°©ë²•
- **íŒŒì¼**: `app/api/diary/analyze/stream/route.ts`
- **ë³€ê²½**: try-catchë¡œ ì•ˆì „í•˜ê²Œ JSON íŒŒì‹±

```typescript
// ë³€ê²½ ì „
const errorData = errorText ? JSON.parse(errorText).catch(() => ({})) : {};

// ë³€ê²½ í›„
let errorData: { error?: { message?: string } } = {};
if (errorText) {
  try {
    errorData = JSON.parse(errorText);
  } catch (parseError) {
    errorData = {};
  }
}
```

**íš¨ê³¼**:
- âœ… Gemini API ì˜¤ë¥˜ ì²˜ë¦¬ ì •ìƒ ì‘ë™
- âœ… í´ë°± ë¡œì§ ì •ìƒ ì‘ë™
- âœ… TypeScript íƒ€ì… ì•ˆì •ì„± í–¥ìƒ

---

### 8. Prisma íŠ¸ëœì­ì…˜ íƒ€ì„ì•„ì›ƒ í•´ê²° âœ…

#### 8.1 ë¬¸ì œ ë°œê²¬
- **ë¬¸ì œ**: `Transaction API error: Unable to start a transaction in the given time`
- **ì˜¤ë¥˜ ì½”ë“œ**: `P2028`
- **ì˜í–¥**: ë¶„ì„ ì™„ë£Œ í›„ ê²°ê³¼ ì €ì¥ ì‹¤íŒ¨, ì‚¬ìš©ìì—ê²Œ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ

#### 8.2 í•´ê²° ë°©ë²•
- **íŒŒì¼**: `app/api/diary/analyze/stream/route.ts`
- **ë³€ê²½**:
  1. íŠ¸ëœì­ì…˜ íƒ€ì„ì•„ì›ƒ ì˜µì…˜ ì¶”ê°€ (`maxWait: 30000`, `timeout: 60000`)
  2. íƒ€ì„ì•„ì›ƒ ì‹œ ê°œë³„ ì—…ë°ì´íŠ¸ë¡œ í´ë°±í•˜ì—¬ ê²°ê³¼ ì €ì¥ ë³´ì¥

```typescript
await prisma.$transaction(async (tx) => {
  // íŠ¸ëœì­ì…˜ ë¡œì§
}, {
  maxWait: 30000, // íŠ¸ëœì­ì…˜ ì‹œì‘ ëŒ€ê¸° ìµœëŒ€ ì‹œê°„: 30ì´ˆ
  timeout: 60000, // íŠ¸ëœì­ì…˜ ì‹¤í–‰ ìµœëŒ€ ì‹œê°„: 60ì´ˆ
});

// íƒ€ì„ì•„ì›ƒ ì‹œ í´ë°±
catch (transactionError: any) {
  if (transactionError?.code === 'P2028') {
    // ê°œë³„ ì—…ë°ì´íŠ¸ë¡œ í´ë°±
    await prisma.analysisResult.update({...});
    // DiaryEntry ì—…ë°ì´íŠ¸ë„ ì‹œë„ (ì‹¤íŒ¨í•´ë„ ë¬´ì‹œ)
  }
}
```

**íš¨ê³¼**:
- âœ… íŠ¸ëœì­ì…˜ íƒ€ì„ì•„ì›ƒ ë°©ì§€
- âœ… íƒ€ì„ì•„ì›ƒ ë°œìƒ ì‹œì—ë„ ë¶„ì„ ê²°ê³¼ ì €ì¥ ë³´ì¥
- âœ… ì‚¬ìš©ì ê²½í—˜ ê°œì„  (ì˜¤ë¥˜ ë©”ì‹œì§€ ê°ì†Œ)

---

### 9. PrismaClient ì´ˆê¸°í™” ì˜¤ë¥˜ ìˆ˜ì • âœ…

#### 9.1 ë¬¸ì œ ë°œê²¬
- **ë¬¸ì œ**: `admin/crisis-alerts/[id]/logs/route.ts`ì—ì„œ `new PrismaClient()` ì§ì ‘ ì‚¬ìš©
- **ì˜¤ë¥˜**: Prisma 7ì—ì„œëŠ” adapterê°€ í•„ìš”í•˜ë¯€ë¡œ ì‹±ê¸€í†¤ ì‚¬ìš© í•„ìš”
- **ì˜í–¥**: ë¹Œë“œ ì‹¤íŒ¨

#### 9.2 í•´ê²° ë°©ë²•
- **íŒŒì¼**: `app/api/admin/crisis-alerts/[id]/logs/route.ts`
- **ë³€ê²½**: ì‹±ê¸€í†¤ `prisma` ì¸ìŠ¤í„´ìŠ¤ ì‚¬ìš©

```typescript
// ë³€ê²½ ì „
import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();

// ë³€ê²½ í›„
import { prisma } from '@/app/lib/prisma';
```

**íš¨ê³¼**:
- âœ… ë¹Œë“œ ì„±ê³µ
- âœ… Prisma 7.1.0 í˜¸í™˜ì„± í™•ë³´
- âœ… ì¼ê´€ëœ PrismaClient ì‚¬ìš©

---

### 10. TypeScript ì˜¤ë¥˜ ìˆ˜ì • (draft route) âœ…

#### 10.1 ë¬¸ì œ ë°œê²¬
- **ë¬¸ì œ**: `existingDraft` ë³€ìˆ˜ê°€ ìŠ¤ì½”í”„ ë°–ì—ì„œ ì‚¬ìš©ë¨
- **ì˜¤ë¥˜**: `Cannot find name 'existingDraft'`
- **ì˜í–¥**: ë¹Œë“œ ì‹¤íŒ¨

#### 10.2 í•´ê²° ë°©ë²•
- **íŒŒì¼**: `app/api/diary/draft/route.ts`
- **ë³€ê²½**: `existingDraft` ë³€ìˆ˜ë¥¼ ìƒìœ„ ìŠ¤ì½”í”„ì— ì„ ì–¸

```typescript
let existingDraft: { id: string } | null = null;

if (draftToUpdate) {
  existingDraft = await prisma.diaryEntry.findUnique({...});
  // ...
}

if (!draftToUpdate || !existingDraft) {
  // ìƒˆ ì„ì‹œì €ì¥ ìƒì„±
}
```

**íš¨ê³¼**:
- âœ… ë¹Œë“œ ì„±ê³µ
- âœ… íƒ€ì… ì•ˆì •ì„± í–¥ìƒ

---

## ğŸ“ í–¥í›„ êµ¬í˜„ ì˜ˆì • ê¸°ëŠ¥

### ì†Œí”„íŠ¸ ë”œë¦¬íŠ¸(Soft Delete) ê¸°ëŠ¥
- **ëª©ì **: ì‹¤ìˆ˜ ë°©ì§€ ë° ì•…ì˜ì  ì‚­ì œ ë°©ì§€
- **ì „ëµ**: "ë³´ì´ì§€ ì•ŠëŠ” ì•ˆì „ë§" - ì‚¬ìš©ìì—ê²ŒëŠ” ì‚­ì œë¡œ ë³´ì´ì§€ë§Œ 30ì¼ê°„ ë³´ê´€
- **ë³´ì•ˆ**: íœ´ì§€í†µ UI ë…¸ì¶œ ì—†ì´ ë°±ê·¸ë¼ìš´ë“œì—ì„œë§Œ ë³´ì¡´
- **ë³µêµ¬**: Adminì„ í†µí•œ ë³µêµ¬ ê¸°ëŠ¥ ì œê³µ
- **ìë™ ì •ë¦¬**: 30ì¼ ê²½ê³¼ í›„ ì˜êµ¬ ì‚­ì œ
- **ìƒì„¸ ë¬¸ì„œ**: `docs/FUTURE_SOFT_DELETE_IMPLEMENTATION.md` ì°¸ì¡°

---

## ğŸ“š ì°¸ê³  ìë£Œ

- [Prisma 7.1.0 Release Notes](https://github.com/prisma/prisma/releases)
- [Prisma Client Constructor](https://pris.ly/d/client-constructor)
- [Prisma Config File](https://pris.ly/d/config-datasource)
- [Vercel Serverless Functions Best Practices](https://vercel.com/docs/concepts/functions/serverless-functions)
- [Prisma Serverless Best Practices](https://www.prisma.io/docs/guides/performance-and-optimization/connection-management#serverless-environments)
