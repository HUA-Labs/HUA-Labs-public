# Slip & Crisis Detection System

> 사용자 정신건강 패턴 감지 및 전문가 상담 지원 시스템

---

## 1. 시스템 개요

### 1.1 목적

- **1차 목적**: 사용자의 감정 패턴에서 주의가 필요한 상태 조기 감지
- **2차 목적**: 전문가 상담 전 사전 레포트 생성으로 상담 효율화
- **최종 목표**: 사용자가 자신의 패턴을 이해하고, 필요시 전문가와 효과적으로 소통

### 1.2 핵심 원칙

1. **비진단적 접근**: 진단이 아닌 "패턴 관찰" 및 "주의 신호"로 표현
2. **자기결정권 존중**: 사용자가 레포트 생성 및 공유 여부 결정
3. **점진적 에스컬레이션**: 단일 이벤트가 아닌 패턴 누적으로 판단
4. **투명성**: 왜 이 판단이 내려졌는지 reasoning 제공

---

## 2. 데이터 구조

### 2.1 1차 분석 (AnalysisResult)

```
┌─────────────────────────────────────────────────────┐
│ AnalysisResult                                       │
├─────────────────────────────────────────────────────┤
│ affect_tier (tier_a)  : 1.0-5.0  감정 강도           │
│ momentum_tier (tier_m): 1.0-5.0  운동성/동력          │
│ ethics[]              : 태그 배열 (영어)              │
│ slip                  : none | soft | hard           │
│ mode                  : empathy | analysis | ...     │
│ tone                  : gentle | warm | ...          │
│ confidence            : 0.0-1.0                      │
└─────────────────────────────────────────────────────┘
```

### 2.2 2차 분석 (HuaEmotionAnalysis)

```
┌─────────────────────────────────────────────────────┐
│ HuaEmotionAnalysis                                   │
├─────────────────────────────────────────────────────┤
│ valence  : -1.0 ~ 1.0  감정 극성                     │
│ arousal  : 0.0 ~ 1.0   각성 수준                     │
│ entropy  : 0.0 ~ 1.0   감정 복잡도                   │
│ density  : 0.0 ~ 1.0   감정 밀도                     │
│ dominant_emotion       : 주요 감정                   │
└─────────────────────────────────────────────────────┘
```

### 2.3 위기 알림 (CrisisAlert)

```
┌─────────────────────────────────────────────────────┐
│ CrisisAlert                                          │
├─────────────────────────────────────────────────────┤
│ crisis_types[]  : SUICIDE | SELF_HARM | DRUG | ...  │
│ risk_level      : 1-4                                │
│ ai_detected     : boolean                           │
│ keyword_detected: boolean                           │
│ historical_context: JSON (에스컬레이션 정보)         │
└─────────────────────────────────────────────────────┘
```

---

## 3. Tier 해석 매트릭스

### 3.1 A (감정반응성) × M (운동성) 조합

| A \ M | M 낮음 (1-2) | M 중간 (2-3) | M 높음 (4-5) |
|-------|-------------|-------------|-------------|
| **A 낮음 (1-2)** | 온화/평온 OR 무감각 | 안정적 일상 | 기계적 과활동 |
| **A 중간 (2-3)** | 약간 우울/지침 | 일반적 상태 | 생산적 몰입 |
| **A 높음 (4-5)** | 감정 막힘/우울 | 감정적 날 | 창발/폭주 (경조증?) |

### 3.2 핵심 통찰

- **같은 숫자도 맥락에 따라 의미가 다름**
- **ethics 태그가 맥락을 결정**
- **연속 패턴이 단일 이벤트보다 중요**

---

## 4. Slip 시스템

### 4.1 Slip 레벨 정의

| Level | 의미 | 트리거 조건 |
|-------|------|------------|
| `none` | 정상 | 균형 잡힌 상태 |
| `soft` | 주의 필요 | 불균형 감지, 의심 패턴 |
| `hard` | 심각 주의 | 다중 위험 요소, 에스컬레이션 |

### 4.2 패턴 유형

```typescript
type SuspectedPattern =
  | 'hypomania'       // 경조증: A높음 + M높음 + 충동성/수면감소
  | 'depression'      // 우울: A높음 + M낮음 + 탈진/고립
  | 'over-immersion'  // 과몰입: A낮음 + M높음 + 감정 없는 활동
  | 'burnout'         // 번아웃: A낮음 + M낮음 + 탈진
  | 'mixed'           // 혼재: 경조증 ↔ 우울 교차
  | null;             // 패턴 없음
```

### 4.3 경조증 지표 태그

```typescript
const HYPOMANIA_INDICATORS = [
  'impulsivity',      // 충동성
  'sleep-reduction',  // 수면 감소
  'hyperactivity',    // 과활동
  'grandiosity',      // 과대자신감
  'racing-thoughts',  // 사고의 비약
  'risk-taking',      // 위험 감수
  'overspending',     // 과소비
  'irritability',     // 과민함
];
```

### 4.4 우울 지표 태그

```typescript
const DEPRESSION_INDICATORS = [
  'exhaustion',       // 탈진
  'hopelessness',     // 절망감
  'isolation',        // 고립
  'anhedonia',        // 무쾌감
  'self-neglect',     // 자기방치
  'withdrawal',       // 위축
];
```

---

## 5. 에스컬레이션 시스템

### 5.1 Slip 에스컬레이션 규칙

```
규칙 1: 연속 3일 soft → hard 에스컬레이트
규칙 2: 7일 중 5일 이상 soft → hard
규칙 3: 경조증 → 우울 (또는 반대) 급격한 전환 → hard
규칙 4: AI 분석에서 높은 confidence로 위험 패턴 감지 → hard
```

### 5.2 Crisis 에스컬레이션 규칙 (기존)

```
규칙 1: 최근 7일 3건 이상 알림 → +1
규칙 2: 연속 3일 이상 알림 → +1
규칙 3: 평균 위험도 높고 반복 → +1
규칙 4: 급격한 위험도 상승 (1 → 3) → +1
```

### 5.3 통합 에스컬레이션

```
┌──────────────────────────────────────────────────────────┐
│                    에스컬레이션 흐름                       │
├──────────────────────────────────────────────────────────┤
│                                                          │
│   일기 작성 → 1차 분석 → Slip 계산 → 히스토리 조회        │
│                            ↓                             │
│                    에스컬레이션 판단                       │
│                            ↓                             │
│              ┌────────────┴────────────┐                 │
│              ↓                         ↓                 │
│        Slip 저장               Crisis 생성 (필요시)       │
│              ↓                         ↓                 │
│        사용자 피드백              어드민 알림             │
│        (선택적, 조심스럽게)                               │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

---

## 6. 전문가 상담 레포트 (미래 기능)

### 6.1 레포트 목적

- 첫 상담 시간 절약
- 본인이 말로 표현하기 어려운 패턴 시각화
- 전문가가 빠르게 맥락 파악

### 6.2 레포트 구성 (안)

```
┌──────────────────────────────────────────────────────────┐
│              전문가 사전상담 레포트                        │
├──────────────────────────────────────────────────────────┤
│                                                          │
│ 1. 요약                                                  │
│    - 분석 기간: 2025-11-01 ~ 2025-11-30                 │
│    - 총 일기 수: 28개                                    │
│    - 주요 패턴: 경조증 ↔ 우울 사이클 의심                 │
│                                                          │
│ 2. 감정 추이 그래프                                       │
│    - Valence (감정 극성) 시계열                          │
│    - Arousal (각성 수준) 시계열                          │
│    - Tier A/M 추이                                       │
│                                                          │
│ 3. 패턴 분석                                             │
│    - 경조증 의심 구간: 11/10-11/14 (5일)                 │
│      → 수면 감소, 충동 소비, 과대 자신감                  │
│    - 우울 구간: 11/01-11/05 (5일)                       │
│      → 무기력, 고립, 자기방치                            │
│                                                          │
│ 4. 주요 태그 빈도                                        │
│    - exhaustion: 12회                                   │
│    - impulsivity: 8회                                   │
│    - isolation: 7회                                     │
│    - sleep-reduction: 6회                               │
│                                                          │
│ 5. 에스컬레이션 이력                                      │
│    - 11/03: soft → hard (연속 3일 우울 패턴)            │
│    - 11/13: soft → hard (경조증 + 충동 소비)            │
│                                                          │
│ 6. 참고 사항                                             │
│    - 이 레포트는 진단이 아닌 패턴 관찰입니다              │
│    - 최종 판단은 전문가와 상담하세요                      │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

### 6.3 데이터 요구사항

레포트 생성을 위해 필요한 데이터:

| 데이터 | 현재 상태 | 필요 작업 |
|--------|---------|----------|
| slip 히스토리 | ✅ AnalysisResult.slip | 조회 함수 필요 |
| tier_a/tier_m 추이 | ✅ AnalysisResult | 조회 함수 필요 |
| ethics 태그 누적 | ✅ AnalysisResult.ethics | 집계 함수 필요 |
| valence/arousal 추이 | ✅ HuaEmotionAnalysis | 조회 함수 필요 |
| crisis 알림 이력 | ✅ CrisisAlert | 이미 있음 |
| 에스컬레이션 이력 | ⚠️ 부분적 | 별도 저장 필요할 수 있음 |

---

## 7. 구현 계획

### Phase 1: Slip 고도화 (현재)

- [x] slip-calculator v2: 경조증/우울 패턴 감지
- [x] ethics 태그 영어화 (프롬프트 수정)
- [x] slip 히스토리 조회 함수 (`getHistoricalSlipContext`)
- [x] slip 에스컬레이션 로직 (`calculateSlipEscalation`)
- [x] 통합 함수 (`calculateFinalSlipWithEscalation`)
- [ ] prompt-test에서 AI 기반 slip 분석 옵션
- [ ] 기존 분석 파이프라인에 에스컬레이션 통합

### Phase 2: 통합 및 테스트

- [ ] 기존 분석 파이프라인에 slip 에스컬레이션 통합
- [ ] 테스트 데이터로 검증 (경조증 목데이터)
- [ ] 어드민 대시보드에서 slip 패턴 시각화

### Phase 3: 레포트 시스템

- [ ] 레포트 데이터 집계 API
- [ ] 레포트 생성 UI (사용자 요청 시)
- [ ] PDF/마크다운 내보내기
- [ ] 전문가 공유 기능 (암호화된 링크)

### Phase 4: 고도화

- [ ] 시계열 패턴 분석 (사이클 감지)
- [ ] 개인화된 베이스라인 학습
- [ ] 위험 예측 모델 (선택적)

---

## 8. 주의사항

### 8.1 윤리적 고려

1. **과잉 경고 방지**: 너무 자주 경고하면 사용자가 무시하게 됨
2. **낙인 방지**: "경조증", "우울" 같은 용어는 내부용, 사용자에게는 순화된 표현
3. **자기결정권**: 레포트 생성은 사용자가 직접 요청할 때만
4. **데이터 보호**: 레포트는 사용자만 접근 가능, 공유도 사용자 결정

### 8.2 기술적 고려

1. **성능**: 에스컬레이션 계산이 분석 속도에 영향 주지 않도록
2. **정확도**: 오탐(false positive) 최소화
3. **확장성**: 새로운 패턴 추가 용이하게 설계

---

## 9. 관련 파일

```
apps/my-app/
├── app/lib/
│   ├── slip-calculator.ts          # Slip 계산 (v2)
│   ├── crisis-detection-service.ts # Crisis 감지 및 에스컬레이션
│   ├── anonymizer.ts               # 위험 신호 감지
│   └── prompts/
│       └── core.ts                 # 분석 프롬프트 (ethics 태그 정의)
├── prisma/
│   └── schema.prisma               # SlipLevel enum, AnalysisResult
└── docs/
    └── slip-crisis-system.md       # 이 문서
```

---

## 변경 이력

| 날짜 | 버전 | 변경 내용 |
|------|------|----------|
| 2026-01-26 | 1.0 | 초안 작성 |
