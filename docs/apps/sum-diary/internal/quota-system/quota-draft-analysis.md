# 📝 Quota 수치 및 임시저장/전송 관계 분석

> 작성일: 2025-12-06  
> 목적: Quota 수치 적정성 검토 및 임시저장-전송 관계 정리

---

## 🔍 현재 플로우 분석

### 1. 임시저장 (Draft)
- **로컬**: localStorage에 3초마다 자동 저장
- **서버**: `/api/diary/draft` API로 저장 (최대 10개)
- **특징**: 제목이 "임시저장"으로 시작
- **Quota 체크**: ❌ 없음

### 2. 전송 (최종 저장)
- **API**: `/api/diary/create`
- **특징**: 실제 일기로 저장 (제목이 "임시저장"이 아님)
- **Quota 체크**: ❌ 현재 없음 (구현 예정)

---

## ⚠️ 발견된 문제점

### 문제 1: 임시저장 → 전송 우회 가능성

**시나리오:**
```
1. 사용자가 임시저장 10개 생성 (Quota 체크 없음)
2. 나중에 임시저장을 모두 전송
3. → Quota를 우회하여 일기를 많이 작성할 수 있음
```

**현재 제한:**
- 임시저장 최대 10개 (코드에 하드코딩)
- 하지만 전송 시 Quota 체크가 없으면 문제

### 문제 2: Quota 수치 적정성

**제안된 수치:**
- 무료: 일기 10/300, 분석 5/150
- 프리미엄: 일기 100/3000, 분석 50/1500

**검토 필요:**
- 일일 10개는 적당한가? (일반 사용자 기준)
- 월간 300개는 적당한가? (하루 평균 10개)
- 분석 5개는 적당한가? (일기 10개 중 5개만 분석)

---

## 💡 해결 방안

### 방안 1: 전송 시에만 Quota 체크 (권장)

**전략:**
- 임시저장: Quota 체크 없음 (작성 중이므로)
- 전송 시: Quota 체크 + 증가

**장점:**
- 사용자 경험 좋음 (작성 중 제한 없음)
- 최종 전송만 제한하면 됨
- 구현 단순

**단점:**
- 임시저장을 많이 만들고 나중에 전송하면 우회 가능
- → **임시저장 개수 제한으로 완화** (이미 10개 제한 있음)

**구현:**
```typescript
// /api/diary/create
1. Quota 체크 (일기 작성 가능?)
2. 가능하면 일기 저장
3. Quota 증가
4. 임시저장 삭제 (같은 날짜의 임시저장이 있으면)
```

---

### 방안 2: 임시저장도 Quota에 포함

**전략:**
- 임시저장 생성 시: Quota 체크
- 전송 시: Quota 증가 (이미 체크됨)

**장점:**
- 우회 불가능
- 엄격한 제한

**단점:**
- 사용자 경험 나쁨 (작성 중에도 제한)
- 임시저장을 여러 번 수정하면 Quota 소모
- 구현 복잡

**비권장**: 사용자 경험 저하

---

### 방안 3: 하이브리드 (임시저장은 별도 Quota)

**전략:**
- 임시저장: 별도 Quota (예: 일일 20개)
- 전송: 일반 Quota (일일 10개)

**장점:**
- 임시저장과 전송 구분
- 유연한 제한

**단점:**
- 복잡도 증가
- 두 가지 Quota 관리 필요

**비권장**: 복잡도 대비 이득 적음

---

## ✅ 권장 방안: 방안 1 (전송 시에만 Quota 체크)

### 구현 상세

**1. 임시저장 생성 (`/api/diary/draft`)**
- Quota 체크: ❌ 없음
- 개수 제한: 최대 10개 (기존 로직 유지)

**2. 전송 (`/api/diary/create`)**
- Quota 체크: ✅ 필수
- Quota 증가: ✅ 전송 성공 시
- 임시저장 삭제: ✅ 같은 날짜의 임시저장 자동 삭제

**3. 임시저장 → 전송 변환**
- 임시저장을 불러와서 전송하는 경우도 Quota 체크
- 임시저장 자체는 Quota에 포함 안 됨

---

## 📊 Quota 수치 재검토

### 현재 제안
- **무료**: 일기 10/300, 분석 5/150
- **프리미엄**: 일기 100/3000, 분석 50/1500

### 검토 포인트

#### 1. 일일 일기 작성: 10개
**의견:**
- ✅ 적당함 (일반 사용자는 하루 1-2개 작성)
- ✅ 베타 단계에서 충분
- ⚠️ 하지만 임시저장을 많이 만들고 나중에 전송하면 우회 가능

**완화책:**
- 임시저장 최대 10개 제한 (이미 있음)
- 전송 시 Quota 체크 (구현 예정)

#### 2. 월간 일기 작성: 300개
**의견:**
- ✅ 적당함 (하루 평균 10개)
- ✅ 일반 사용자는 월 30-60개 정도 작성 예상

#### 3. 일일 분석: 5개
**의견:**
- ⚠️ **일기 10개 중 5개만 분석 가능**
- ⚠️ 사용자가 모든 일기를 분석하고 싶을 수 있음
- ⚠️ 일기 작성과 분석 비율이 맞지 않음

**제안:**
- 일일 분석: **10개** (일기 작성과 동일)
- 또는 일일 분석: **7-8개** (일기 대비 70-80%)

#### 4. 월간 분석: 150개
**의견:**
- ⚠️ 일기 300개 중 150개만 분석 가능
- ⚠️ 비율이 맞지 않음

**제안:**
- 월간 분석: **300개** (일기 작성과 동일)
- 또는 월간 분석: **250개** (일기 대비 80%)

---

## 🎯 수정된 Quota 수치 제안

### 옵션 A: 일기와 분석 동일 (권장)

| 사용자 | 일일 일기 | 월간 일기 | 일일 분석 | 월간 분석 |
|--------|-----------|-----------|-----------|-----------|
| 무료 | 10개 | 300개 | **10개** | **300개** |
| 프리미엄 | 100개 | 3000개 | **100개** | **3000개** |

**이유:**
- 일기 작성과 분석 비율 일치
- 사용자가 모든 일기를 분석할 수 있음
- 단순하고 직관적

---

### 옵션 B: 분석을 약간 낮게

| 사용자 | 일일 일기 | 월간 일기 | 일일 분석 | 월간 분석 |
|--------|-----------|-----------|-----------|-----------|
| 무료 | 10개 | 300개 | **7개** | **250개** |
| 프리미엄 | 100개 | 3000개 | **70개** | **2500개** |

**이유:**
- 분석은 비용이 더 많이 듦
- 모든 일기를 분석하지 않을 수도 있음
- 약간의 여유 제공

---

### 옵션 C: 원래 제안 유지

| 사용자 | 일일 일기 | 월간 일기 | 일일 분석 | 월간 분석 |
|--------|-----------|-----------|-----------|-----------|
| 무료 | 10개 | 300개 | **5개** | **150개** |
| 프리미엄 | 100개 | 3000개 | **50개** | **1500개** |

**이유:**
- 분석 비용이 더 높으므로 제한을 더 엄격하게
- 사용자가 선택적으로 분석하도록 유도

---

## 🔧 임시저장-전송 관계 정리

### 현재 상태
- 임시저장: Quota 체크 없음, 최대 10개
- 전송: Quota 체크 없음 (구현 예정)

### 구현 계획

**1. 전송 시 Quota 체크**
```typescript
// /api/diary/create
export async function POST(request: NextRequest) {
  // 1. Quota 체크
  await checkQuotaOrThrow(userId, 'diary', 'daily');
  await checkQuotaOrThrow(userId, 'diary', 'monthly');
  
  // 2. 일기 저장
  const diary = await prisma.diaryEntry.create({ ... });
  
  // 3. Quota 증가
  await incrementUserQuota(userId, 'diary', 'daily');
  await incrementUserQuota(userId, 'diary', 'monthly');
  
  // 4. 같은 날짜의 임시저장 삭제
  await deleteDraftByDate(diaryDate);
}
```

**2. 임시저장 개수 제한 유지**
- 최대 10개 (기존 로직 유지)
- 임시저장이 많아도 전송 시 Quota 체크로 제한

**3. 임시저장 → 전송 변환**
- 임시저장을 불러와서 전송하는 경우도 Quota 체크
- 임시저장 자체는 Quota에 포함 안 됨

---

## 📝 최종 권장사항

### 1. Quota 수치
**권장: 옵션 A (일기와 분석 동일)**
- 무료: 일기 10/300, 분석 **10/300**
- 프리미엄: 일기 100/3000, 분석 **100/3000**

**이유:**
- 비율 일치로 직관적
- 사용자가 모든 일기를 분석할 수 있음
- 단순한 구조

### 2. 임시저장-전송 관계
**권장: 전송 시에만 Quota 체크**
- 임시저장: Quota 체크 없음 (작성 중이므로)
- 전송 시: Quota 체크 + 증가
- 임시저장 최대 10개 제한 유지

**이유:**
- 사용자 경험 좋음
- 구현 단순
- 임시저장 개수 제한으로 우회 완화

---

## 🎯 의사결정 체크리스트

### Quota 수치
- [ ] 일일 분석: 5개? 10개? 7개?
- [ ] 월간 분석: 150개? 300개? 250개?
- [ ] 일기와 분석 비율: 동일? 분석 낮게?

### 임시저장-전송 관계
- [x] 전송 시에만 Quota 체크 (권장)
- [x] 임시저장은 Quota 체크 없음
- [x] 임시저장 최대 10개 제한 유지

---

**작성자**: Auto (AI Assistant)  
**태그**: #quota #draft #analysis #beta-launch

